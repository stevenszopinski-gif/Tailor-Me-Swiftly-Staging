<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://pagead2.googlesyndication.com https://www.googletagmanager.com https://esm.sh https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co https://pagead2.googlesyndication.com https://api.elevenlabs.io; frame-src https://js.stripe.com https://pagead2.googlesyndication.com;">
    <link rel="alternate" type="application/rss+xml" title="TailorMeSwiftly.com Release Notes" href="/feed.xml">
    <title>System Dashboard | TailorMeSwiftly</title>
    <link rel="stylesheet" href="style.css?v=5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-stat {
            background: rgba(var(--primary-color-rgb), 0.1);
            border: 1px solid var(--primary-color);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
        }

        .admin-stat h3 {
            font-size: 3rem;
            margin: 0;
            color: var(--primary-color);
        }

        .admin-stat p {
            margin: 0;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            text-align: left;
        }

        .user-table th,
        .user-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--panel-border);
        }

        .user-table th {
            color: var(--text-secondary);
            font-weight: 500;
        }
    </style>
</head>

<body data-theme="light">
    <a href="#main-content" class="skip-nav">Skip to main content</a>
    <div class="app-container" style="max-width: 1200px;">
        <header class="app-header" role="banner">
            <div class="logo">
                <div class="logo-icon"><i class="fa-solid fa-shield-halved"></i></div>
                <h1>TMS Admin System</h1>
            </div>
            <div id="product-switcher" class="product-switcher"></div>
            <div class="header-actions">
                <a href="app.html" class="btn secondary-btn">Back to App</a>
            </div>
        </header>

        <main id="main-content" class="glass-panel" style="padding: 2rem; border-radius: 20px;" id="admin-content">
            <div id="loading" style="text-align: center; padding: 4rem;">
                <i class="fa-solid fa-spinner fa-spin fa-2x" style="color: var(--primary-color);"></i>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Verifying Admin Credentials...</p>
            </div>

            <div id="dashboard-view" style="display: none;">
                <h2 style="margin-bottom: 2rem; border-bottom: 1px solid var(--panel-border); padding-bottom: 1rem;">
                    System Overview</h2>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem;">
                    <div class="admin-stat">
                        <h3 id="stat-users">0</h3>
                        <p>Total Registered Users</p>
                    </div>
                    <div class="admin-stat">
                        <h3 id="stat-apps">0</h3>
                        <p>Total Applications Tailored</p>
                    </div>
                    <div class="admin-stat">
                        <h3 id="stat-views">0</h3>
                        <p>Unique Page Views</p>
                        <small style="color: var(--text-secondary); font-size: 0.7rem;">(Excluding Admin)</small>
                    </div>
                </div>

                <h3 style="margin-top: 4rem; margin-bottom: 1rem;">Recent Users</h3>
                <div style="overflow-x: auto;">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Joined</th>
                                <th>Last Sign In</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 4rem; margin-bottom: 1rem;">Recent Page Activity</h3>
                <div style="overflow-x: auto;">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Page Path</th>
                                <th>Event Type</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity-body">
                            <!-- Populated by JS -->
                            <tr>
                                <td colspan="3" style="text-align:center; color: var(--text-secondary);">No recent
                                    activity tracked.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="unauthorized-view" style="display: none; text-align: center; padding: 4rem;">
                <i class="fa-solid fa-lock fa-3x" style="color: #f85149; margin-bottom: 1rem;"></i>
                <h2>Access Denied</h2>
                <p style="color: var(--text-secondary);">You do not have permission to view this page. This area is
                    restricted to stevenszopinski@gmail.com.</p>
                <a href="login.html" class="btn primary-btn" style="margin-top: 2rem; display: inline-block;">Return to
                    Login</a>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="brand-config.js"></script>
    <script src="auth.js?v=10"></script>
    <script src="components.js"></script>
    <script src="error-utils.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();

            if (!user || user.email !== 'stevenszopinski@gmail.com') {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('unauthorized-view').style.display = 'block';
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';

            // Fetch actual user count and data
            // Note: In standard Supabase, auth.users is not accessible from the client for security reasons.
            // A secure backend function should be used. For this prototype, we will rely on a secure RPC 
            // call or proxy if available, but for now we simulate fetching if direct access fails.

            try {
                // Fetch generation counts
                const { count: genCount, error: genErr } = await supabaseClient
                    .from('generations')
                    .select('*', { count: 'exact', head: true });

                if (!genErr) document.getElementById('stat-apps').textContent = genCount || 0;

                // For users, ideally use an Edge Function. If unavailable, show a placeholder error.
                // We will attempt to use a custom RPC 'get_all_users_admin' if it exists.
                const { data: users, error: userErr } = await supabaseClient.rpc('get_all_users_admin');

                if (userErr) {
                    document.getElementById('stat-users').textContent = 'Requires Admin RPC';
                    document.getElementById('user-table-body').innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--text-secondary);">Create a Supabase RPC function named "get_all_users_admin" to bypass RLS and display user lists here.</td></tr>';
                } else if (users && users.length > 0) {
                    document.getElementById('stat-users').textContent = users.length;
                    let tableHtml = '';
                    users.forEach(u => {
                        tableHtml += `<tr>
                             <td>${u.email}</td>
                             <td>${new Date(u.created_at).toLocaleDateString()}</td>
                             <td>${new Date(u.last_sign_in_at).toLocaleDateString()}</td>
                         </tr>`;
                    });
                    document.getElementById('user-table-body').innerHTML = tableHtml;
                }


                // Fetch unique page views
                const { count: viewCount, error: viewErr } = await supabaseClient
                    .from('analytics_events')
                    .select('*', { count: 'exact', head: true });

                if (!viewErr) document.getElementById('stat-views').textContent = viewCount || 0;

                // Fetch recent page views
                const { data: recentViews, error: recentErr } = await supabaseClient
                    .from('analytics_events')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (!recentErr && recentViews) {
                    let activityHtml = '';
                    recentViews.forEach(v => {
                        activityHtml += `<tr>
                            <td>${v.page_path}</td>
                            <td>${v.event_type}</td>
                            <td>${new Date(v.created_at).toLocaleString()}</td>
                        </tr>`;
                    });
                    document.getElementById('recent-activity-body').innerHTML = activityHtml;
                }

            } catch (e) {
                console.error("Admin fetch error: ", e);
            }
        });
    </script>
</body>

</html>