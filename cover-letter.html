<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="alternate" type="application/rss+xml" title="TailorMeSwiftly.com Release Notes" href="/feed.xml">
    <title>Your Cover Letter â€“ TailorMeSwiftly</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=6">
    <link rel="stylesheet" href="templates.css">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7832382680038641"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.min.js"></script>
    <style>
        .result-page {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem 1.5rem 4rem;
        }

        .result-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .result-back {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .result-back:hover {
            color: var(--text-primary);
        }

        .result-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .word-bar {
            display: flex;
            gap: 0.8rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            align-items: center;
        }

        .cover-output {
            background: #fff;
            color: #111;
            border-radius: 8px;
            padding: 2.5rem;
            min-height: 400px;
            outline: none;
            line-height: 1.75;
            font-family: Georgia, serif;
        }

        [data-theme="dark"] .cover-output {
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-primary);
            border: 1px solid var(--panel-border);
        }

        @media (max-width: 480px) {
            .result-page {
                padding: 1rem 1rem 3rem;
            }

            .cover-output {
                padding: 1.5rem;
            }

            .result-header {
                gap: 0.5rem;
            }

            .result-header .btn {
                width: 100%;
                min-height: 48px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container" style="min-height: auto;">
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon"><i class="fa-solid fa-clipboard"></i></div>
                <h1>TailorMeSwiftly.com</h1>
            </div>
            <div class="header-actions" style="display: flex; gap: 1rem; align-items: center;">
                <div id="user-profile" class="user-profile"
                    style="display: none; flex-direction: column; align-items: center; gap: 0.2rem; position: relative;">
                    <img id="user-avatar" src="" alt="Profile"
                        style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer;"
                        onclick="document.getElementById('avatar-dropdown').classList.toggle('hidden')">
                    <span id="user-greeting"
                        style="font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;"></span>
                    <div id="avatar-dropdown" class="avatar-dropdown hidden">
                        <button class="dropdown-item" id="open-prefs" onclick="location.href='app.html'">
                            <i class="fa-solid fa-sliders"></i> Preferences
                        </button>
                        <a href="updates.html" class="dropdown-item" style="text-decoration: none; color: inherit;">
                            <i class="fa-solid fa-bullhorn"></i> Release Notes
                        </a>
                        <a href="history.html" class="dropdown-item" style="text-decoration: none; color: inherit;">
                            <i class="fa-solid fa-table-columns"></i> Application Tracker
                        </a>
                        <button class="dropdown-item theme-btn">
                            <i class="fa-solid fa-moon"></i> Theme
                        </button>
                        <div style="height: 1px; background: var(--panel-border); margin: 0.3rem 0;"></div>
                        <button class="dropdown-item" id="logout-btn">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>
    </div> <!-- /app-container -->

    <div class="result-page">
        <h1 class="result-title" style="text-align:center;margin:0 0 1.25rem;font-size:1.6rem;"><i
                class="fa-solid fa-envelope-open-text" style="color:#0ea5e9;margin-right:0.5rem;"></i>Your Cover Letter
        </h1>
        <div class="result-header">
            <div style="display:flex;gap:0.6rem;align-items:center;flex-wrap:wrap;">
                <div class="word-bar">
                    <span id="word-count"><i class="fa-solid fa-align-left"></i> 0 words</span>
                    <span id="page-est"><i class="fa-regular fa-file"></i> ~1 page</span>
                </div>
                <button id="refine-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-wand-magic-sparkles"></i>
                    Refine</button>
                <button id="regen-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-rotate"></i>
                    Regenerate</button>
                <button id="copy-btn" class="btn small-btn ghost-btn"><i class="fa-regular fa-copy"></i> Copy</button>
                <button id="download-txt-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-file-lines"></i>
                    TXT</button>
                <button id="download-docx-btn" class="btn small-btn ghost-btn"
                    style="color: #2563eb; border-color: rgba(37, 99, 235, 0.2);"><i class="fa-solid fa-file-word"></i>
                    DOCX</button>
                <button id="download-btn" class="btn small-btn"
                    style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border-color:#6366f1;"><i
                        class="fa-solid fa-file-pdf"></i> PDF</button>
            </div>
        </div>

        <div id="cover-output" class="cover-output rich-output-area" contenteditable="true">
            <p style="color:var(--text-secondary);text-align:center;padding:3rem 0;">Loading your cover letter...</p>
        </div>
    </div>

    <!-- Refinement Modal -->
    <div id="refine-modal"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
        <div
            style="background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:20px;padding:2rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
                <h3 style="margin:0;"><i class="fa-solid fa-wand-magic-sparkles"
                        style="color:var(--primary-color);margin-right:0.5rem;"></i>Refine Your Cover Letter</h3>
                <button onclick="document.getElementById('refine-modal').style.display='none';"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary);">&times;</button>
            </div>
            <p style="color:var(--text-secondary);margin-bottom:1rem;">What would you like to change? Provide specific
                instructions:</p>
            <textarea id="refine-input"
                placeholder="e.g., Make it more concise, Add more enthusiasm, Focus on leadership skills, Make it shorter..."
                style="width:100%;height:120px;padding:0.75rem;border:1px solid var(--panel-border);border-radius:8px;background:rgba(255,255,255,0.05);color:var(--text-primary);font-family:inherit;font-size:0.9rem;resize:vertical;"></textarea>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;">
                <button onclick="document.getElementById('refine-modal').style.display='none';" class="btn ghost-btn"
                    style="flex:1;">Cancel</button>
                <button onclick="applyRefinement()" class="btn primary-btn" style="flex:1;"><i
                        class="fa-solid fa-wand-magic-sparkles"></i> Refine</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="auth.js?v=8"></script>
    <script src="error-utils.js"></script>
    <script src="results.js?v=6"></script>
    <script>
        const coverEl = document.getElementById('cover-output');

        initResultTheme();
        initResultAuth();

        const outputs = loadOutputs();

        async function generateCoverOnDemand() {
            coverEl.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:3rem 0;"><i class="fa-solid fa-spinner fa-spin"></i> Generating your tailored cover letter...</p>';

            const systemPrompt = `You are an elite Executive Career Coach and Expert ATS Cover Letter Writer.
Write a 3-4 paragraph cover letter connecting 2-3 achievements to the Job Description.
ALWAYS start with a professional greeting (e.g. "Dear Hiring Manager," or "Dear [Company] Recruiting Team,").
ALWAYS end with a professional closing salutation (e.g. "Sincerely," or "Best regards,") followed by the applicant's full name.
Clean semantic HTML only. No markdown formatting.`;

            const userPrompt = `Resume:\n${outputs?.resumeText}\n\nJob Description:\n${outputs?.jobText}`;

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        contents: [{ parts: [{ text: userPrompt }] }],
                        generationConfig: { temperature: 0.7 }
                    }
                });

                if (error) throw new Error(error.message);

                const text = data.candidates[0].content.parts[0].text.trim();

                // Remove possible markdown formatting from the response
                let cleanHtml = text;
                if (cleanHtml.startsWith('```html')) {
                    cleanHtml = cleanHtml.substring(7);
                    if (cleanHtml.endsWith('```')) cleanHtml = cleanHtml.substring(0, cleanHtml.length - 3);
                }

                outputs.coverHtml = cleanHtml.trim();
                sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
                updateGenerationField(outputs.generationId, { cover_letter_html: outputs.coverHtml });
                renderCoverLetter();
            } catch (e) {
                coverEl.innerHTML = `<p style="color:var(--error-color);text-align:center;">Failed to generate cover letter: ${e.message}<br><button class="btn small-btn primary-btn" style="margin-top:1rem;" onclick="generateCoverOnDemand()"><i class="fa-solid fa-rotate-right"></i> Retry</button></p>`;
            }
        }

        function renderCoverLetter() {
            if (!outputs.coverHtml) {
                coverEl.innerHTML = '<p style="color:var(--text-secondary);text-align:center;">No cover letter available.</p>';
                return;
            }
            coverEl.innerHTML = outputs.coverHtml;
            document.title = `Cover Letter${outputs.applicantName ? ' â€“ ' + outputs.applicantName : ''} â€“ TailorMeSwiftly`;
            updateWordCount();
        }

        if (!outputs) {
            showSessionExpired(document.querySelector('.result-page'));
        } else if (!outputs.coverHtml) {
            coverEl.innerHTML = `<div style="text-align:center;padding:3rem;"><p style="color:var(--text-secondary);margin-bottom:1.5rem;">Your cover letter hasn't been generated yet.</p><button class="btn primary-btn" onclick="generateCoverOnDemand()"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate Cover Letter</button></div>`;
        } else {
            renderCoverLetter();
        }

        document.getElementById('copy-btn').addEventListener('click', e => copyToClipboard(coverEl.innerText, e.currentTarget));

        // Refinement Modal
        document.getElementById('refine-btn').addEventListener('click', () => {
            document.getElementById('refine-modal').style.display = 'flex';
            document.getElementById('refine-input').focus();
        });

        async function applyRefinement() {
            const refinement = document.getElementById('refine-input').value.trim();
            if (!refinement) {
                alert('Please provide refinement instructions.');
                return;
            }

            document.getElementById('refine-modal').style.display = 'none';
            coverEl.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:3rem 0;"><i class="fa-solid fa-spinner fa-spin"></i> Refining your cover letter...</p>';

            const systemPrompt = `You are an elite Executive Career Coach and Expert ATS Cover Letter Writer.
The user has provided the following refinement request. Apply these changes to the existing cover letter.
User refinement: "${refinement}"
Write a 3-4 paragraph cover letter. ALWAYS start with a professional greeting (e.g. "Dear Hiring Manager,") and ALWAYS end with a professional closing salutation (e.g. "Sincerely,") followed by the applicant's full name.
Clean semantic HTML only. No markdown formatting.`;

            const userPrompt = `Current Cover Letter:\n${outputs?.coverHtml}\n\nResume:\n${outputs?.resumeText}\n\nJob Description:\n${outputs?.jobText}`;

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        contents: [{ parts: [{ text: userPrompt }] }],
                        generationConfig: { temperature: 0.7 }
                    }
                });

                if (error) throw new Error(error.message);
                let cleanHtml = data.candidates[0].content.parts[0].text.trim();
                if (cleanHtml.startsWith('```html')) {
                    cleanHtml = cleanHtml.substring(7);
                    if (cleanHtml.endsWith('```')) cleanHtml = cleanHtml.substring(0, cleanHtml.length - 3);
                }

                outputs.coverHtml = cleanHtml.trim();
                sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
                updateGenerationField(outputs.generationId, { cover_letter_html: outputs.coverHtml });
                renderCoverLetter();
            } catch (e) {
                coverEl.innerHTML = `<p style="color:var(--error-color);text-align:center;">Failed to refine: ${e.message}<br><button class="btn small-btn primary-btn" style="margin-top:1rem;" onclick="applyRefinement()"><i class="fa-solid fa-rotate-right"></i> Retry</button></p>`;
            }
        }

        // Download PDF
        document.getElementById('download-btn').addEventListener('click', () => {
            const name = (outputs?.applicantName || 'Applicant').replace(/\s+/g, '_');
            const co = (outputs?.targetCompany || 'Company').replace(/\s+/g, '_');
            downloadAsPDF(coverEl, `${name}_${co}_Cover_Letter.pdf`);
        });

        // Download DOCX
        document.getElementById('download-docx-btn').addEventListener('click', () => {
            const name = (outputs?.applicantName || 'Applicant').replace(/\s+/g, '_');
            const co = (outputs?.targetCompany || 'Company').replace(/\s+/g, '_');
            const filename = `${name}_${co}_Cover_Letter.docx`;

            const docHtml = `
                <!DOCTYPE html><html><head><meta charset="UTF-8">
                <style>
                    body { font-family: 'Arial', sans-serif; line-height: 1.5; color: #000; }
                    p { margin-bottom: 12pt; }
                </style>
                </head><body>
                ${coverEl.innerHTML}
                </body></html>
            `;

            const converted = htmlDocx.asBlob(docHtml);
            saveAsBlob(converted, filename);
        });

        // Download TXT
        document.getElementById('download-txt-btn').addEventListener('click', () => {
            const name = (outputs?.applicantName || 'Applicant').replace(/\s+/g, '_');
            const co = (outputs?.targetCompany || 'Company').replace(/\s+/g, '_');
            const filename = `${name}_${co}_Cover_Letter.txt`;

            const textContent = coverEl.innerText.replace(/\n{3,}/g, '\n\n').trim();
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            saveAsBlob(blob, filename);
        });

        function saveAsBlob(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateWordCount() {
            const words = (coverEl.innerText || '').trim().split(/\s+/).filter(Boolean).length;
            const pages = Math.max(1, Math.ceil(words / 350));
            document.getElementById('word-count').innerHTML = `<i class="fa-solid fa-align-left"></i> ${words.toLocaleString()} words`;
            document.getElementById('page-est').innerHTML = `<i class="fa-regular fa-file"></i> ~${pages} page${pages !== 1 ? 's' : ''}`;
        }
        new MutationObserver(updateWordCount).observe(coverEl, { childList: true, subtree: true, characterData: true });
        coverEl.addEventListener('input', updateWordCount);
    </script>
</body>

</html>