<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduction Email â€“ TailorMeSwiftly</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=6">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7832382680038641"
        crossorigin="anonymous"></script>
    <style>
        .result-page {
            max-width: 700px;
            margin: 0 auto;
            padding: 1.5rem 1.5rem 4rem;
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-back {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .result-back:hover {
            color: var(--text-primary);
        }

        .result-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .email-card {
            background: var(--glass-bg);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 2rem;
            line-height: 1.75;
            font-size: 0.95rem;
            min-height: 260px;
            outline: none;
        }

        .email-card[contenteditable="true"]:focus {
            border-color: var(--primary-color);
        }

        .subject-line {
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 1.25rem;
            font-size: 1rem;
        }

        .tip-box {
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            padding: 0.9rem 1.1rem;
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-top: 1.25rem;
            display: flex;
            gap: 0.65rem;
            align-items: flex-start;
        }

        .tip-box i {
            color: var(--primary-color);
            margin-top: 0.1rem;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ Company Intel â”€â”€â”€ */
        .company-intel {
            background: var(--glass-bg);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-top: 1.25rem;
        }

        .intel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .intel-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .intel-header h3 i { color: #f59e0b; }

        .intel-items {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .intel-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.65rem 0.8rem;
            background: rgba(99, 102, 241, 0.04);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
            line-height: 1.5;
            transition: border-color 0.15s;
        }

        .intel-item:hover {
            border-color: var(--primary-color);
        }

        .intel-item-text {
            flex: 1;
            color: var(--text-primary);
        }

        .intel-item-text strong {
            color: var(--text-primary);
        }

        .intel-item-text a {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 700;
        }

        .intel-item-text a:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }

        .intel-insert-btn {
            flex-shrink: 0;
            background: none;
            border: 1px solid var(--panel-border);
            color: var(--text-secondary);
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
            font-family: inherit;
        }

        .intel-insert-btn:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .intel-loading {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .intel-footer {
            margin-top: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .intel-footer a {
            font-size: 0.8rem;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .intel-footer a:hover { text-decoration: underline; }
    </style>
</head>

<body>
    <div class="app-container" style="min-height: auto;">
    <header class="app-header">
        <div class="logo">
            <div class="logo-icon"><i class="fa-solid fa-clipboard"></i></div>
            <h1>TailorMeSwiftly.com</h1>
        </div>
        <div class="header-actions" style="display: flex; gap: 1rem; align-items: center;">
            <div id="user-profile" class="user-profile"
                style="display: none; flex-direction: column; align-items: center; gap: 0.2rem; position: relative;">
                <img id="user-avatar" src="" alt="Profile"
                    style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer;"
                    onclick="document.getElementById('avatar-dropdown').classList.toggle('hidden')">
                <span id="user-greeting" style="font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;"></span>
                <div id="avatar-dropdown" class="avatar-dropdown hidden">
                    <button class="dropdown-item" id="open-prefs" onclick="location.href='app.html'">
                        <i class="fa-solid fa-sliders"></i> Preferences
                    </button>
                    <a href="updates.html" class="dropdown-item" style="text-decoration: none; color: inherit;">
                        <i class="fa-solid fa-bullhorn"></i> Release Notes
                    </a>
                    <a href="history.html" class="dropdown-item" style="text-decoration: none; color: inherit;">
                        <i class="fa-solid fa-table-columns"></i> Application Tracker
                    </a>
                    <button class="dropdown-item theme-btn">
                        <i class="fa-solid fa-moon"></i> Theme
                    </button>
                    <div style="height: 1px; background: var(--panel-border); margin: 0.3rem 0;"></div>
                    <button class="dropdown-item" id="logout-btn"
                        onclick="supabaseClient.auth.signOut().then(()=>location.href='index.html')">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>
    </div> <!-- /app-container -->

    <div class="result-page">
        <h1 class="result-title" style="text-align:center;margin:0 0 1.25rem;font-size:1.6rem;"><i class="fa-solid fa-paper-plane" style="color:#f59e0b;margin-right:0.5rem;"></i>Introduction Email</h1>
        <div class="result-header">
            <div style="display:flex;gap:0.6rem;flex-wrap:wrap;">
                <button id="refine-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-wand-magic-sparkles"></i> Refine</button>
                <button id="regen-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-rotate"></i>
                    Regenerate</button>
                <button id="copy-btn" class="btn small-btn primary-btn"><i class="fa-regular fa-copy"></i> Copy</button>
            </div>
        </div>

        <div id="email-card" class="email-card" contenteditable="true">
            <p style="color:var(--text-secondary);text-align:center;padding:3rem 0;">Loading email draft...</p>
        </div>

        <div class="tip-box">
            <i class="fa-solid fa-lightbulb"></i>
            <span>Tip: Personalise the hiring manager's name and reference a recent company news item before sending. Use the intel below to strengthen your outreach.</span>
        </div>

        <div class="company-intel" id="company-intel">
            <div class="intel-header">
                <h3><i class="fa-solid fa-newspaper"></i> <span id="intel-title">Company Intel</span></h3>
                <button id="intel-refresh" class="btn small-btn ghost-btn" style="font-size:0.75rem;padding:0.3rem 0.6rem;" onclick="fetchCompanyIntel()"><i class="fa-solid fa-rotate"></i> Refresh</button>
            </div>
            <div id="intel-content">
                <div class="intel-loading"><i class="fa-solid fa-spinner fa-spin"></i> Gathering recent news &amp; insights...</div>
            </div>
        </div>
    </div>

    <!-- Refinement Modal -->
    <div id="refine-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:20px;padding:2rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
                <h3 style="margin:0;"><i class="fa-solid fa-wand-magic-sparkles" style="color:var(--primary-color);margin-right:0.5rem;"></i>Refine Your Email</h3>
                <button onclick="document.getElementById('refine-modal').style.display='none';" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary);">&times;</button>
            </div>
            <p style="color:var(--text-secondary);margin-bottom:1rem;">What would you like to change? Provide specific instructions:</p>
            <textarea id="refine-input" placeholder="e.g., Make it shorter, Add more personality, Focus on collaboration, Use different tone..." style="width:100%;height:120px;padding:0.75rem;border:1px solid var(--panel-border);border-radius:8px;background:rgba(255,255,255,0.05);color:var(--text-primary);font-family:inherit;font-size:0.9rem;resize:vertical;"></textarea>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;">
                <button onclick="document.getElementById('refine-modal').style.display='none';" class="btn ghost-btn" style="flex:1;">Cancel</button>
                <button onclick="applyRefinement()" class="btn primary-btn" style="flex:1;"><i class="fa-solid fa-wand-magic-sparkles"></i> Refine</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="auth.js?v=6"></script>
    <script src="results.js?v=6"></script>
    <script>
        initResultTheme();
        initResultAuth();

        let outputs = loadOutputs();
        const card = document.getElementById('email-card');

        function renderEmail(text) {
            if (!text) { card.innerHTML = '<p style="color:var(--text-secondary);">No email draft available.</p>'; return; }
            card.innerHTML = text.split('\n').map(line => {
                if (line.startsWith('Subject:')) return `<div class="subject-line">${line}</div>`;
                return `<p style="margin:0.4rem 0;">${line || '&nbsp;'}</p>`;
            }).join('');
        }

        async function generateEmailOnDemand() {
            card.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:2rem;"><i class="fa-solid fa-spinner fa-spin"></i> Generating your introduction email draft...</p>';
            const company = outputs?.targetCompany || 'the company';
            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: `Write a concise introduction email to the hiring manager at ${company}. Subject line first (prefix "Subject: "). Max 150 words. Warm but professional. Reference 1-2 achievements. End with a low-pressure CTA. Plain text only.` }] },
                        contents: [{ parts: [{ text: `Resume:\n${outputs?.resumeText}\n\nJob Description:\n${outputs?.jobText}` }] }],
                        generationConfig: { temperature: 0.8 }
                    }
                });
                if (error) throw new Error(error.message);
                const text = data.candidates[0].content.parts[0].text.trim();
                outputs.emailText = text;
                sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
                updateGenerationField(outputs.generationId, { email_text: outputs.emailText });
                renderEmail(text);
            } catch (e) {
                card.innerHTML = `<p style="color:var(--error-color);text-align:center;">Failed to generate email: ${e.message}<br><button class="btn small-btn primary-btn" style="margin-top:1rem;" onclick="generateEmailOnDemand()"><i class="fa-solid fa-rotate-right"></i> Retry</button></p>`;
            }
        }

        if (!outputs) {
            showSessionExpired(document.querySelector('.result-page'));
        } else if (!outputs.emailText) {
            card.innerHTML = `<div style="text-align:center;padding:3rem;"><p style="color:var(--text-secondary);margin-bottom:1.5rem;">Your introduction email hasn't been generated yet.</p><button class="btn primary-btn" onclick="generateEmailOnDemand()"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate Email</button></div>`;
        } else {
            renderEmail(outputs.emailText);
        }

        document.getElementById('copy-btn').addEventListener('click', e => copyToClipboard(card.innerText, e.currentTarget));

        document.getElementById('refine-btn').addEventListener('click', () => {
            document.getElementById('refine-modal').style.display = 'flex';
            document.getElementById('refine-input').focus();
        });

        async function applyRefinement() {
            const refinement = document.getElementById('refine-input').value.trim();
            if (!refinement) {
                alert('Please provide refinement instructions.');
                return;
            }

            document.getElementById('refine-modal').style.display = 'none';
            card.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:2rem;"><i class="fa-solid fa-spinner fa-spin"></i> Refining your email...</p>';

            const company = outputs?.targetCompany || 'the company';
            const systemPrompt = `You are an expert introduction email writer. Apply the following refinement to the email:
User refinement: "${refinement}"
Write a concise introduction email to the hiring manager at ${company}. Subject line first (prefix "Subject: "). Max 150 words. Warm but professional. Reference 1-2 achievements. End with a low-pressure CTA. Plain text only.`;

            const userPrompt = `Current Email:\n${outputs?.emailText}\n\nResume:\n${outputs?.resumeText}\n\nJob Description:\n${outputs?.jobText}`;

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        contents: [{ parts: [{ text: userPrompt }] }],
                        generationConfig: { temperature: 0.8 }
                    }
                });
                if (error) throw new Error(error.message);
                const text = data.candidates[0].content.parts[0].text.trim();
                outputs.emailText = text;
                sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
                updateGenerationField(outputs.generationId, { email_text: outputs.emailText });
                renderEmail(text);
            } catch (e) {
                card.innerHTML = `<p style="color:var(--error-color);text-align:center;">Failed to refine: ${e.message}<br><button class="btn small-btn primary-btn" style="margin-top:1rem;" onclick="applyRefinement()"><i class="fa-solid fa-rotate-right"></i> Retry</button></p>`;
            }
        }

        document.getElementById('regen-btn').addEventListener('click', async () => {
            const btn = document.getElementById('regen-btn');
            btn.disabled = true;
            outputs.emailText = null;
            sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
            await generateEmailOnDemand();
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Regenerate';
        });

        // â”€â”€ Company Intel â”€â”€
        const companyName = outputs?.targetCompany;
        if (companyName) {
            document.getElementById('intel-title').textContent = 'Recent News About ' + companyName;
            fetchCompanyIntel();
        } else {
            document.getElementById('company-intel').style.display = 'none';
        }

        async function fetchCompanyIntel() {
            const content = document.getElementById('intel-content');
            const refreshBtn = document.getElementById('intel-refresh');
            content.innerHTML = '<div class="intel-loading"><i class="fa-solid fa-spinner fa-spin"></i> Gathering recent news &amp; insights...</div>';
            refreshBtn.disabled = true;

            // Wait for supabaseClient if not ready yet
            if (!window.supabaseClient) {
                await new Promise(resolve => {
                    let tries = 0;
                    const poll = setInterval(() => {
                        if (window.supabaseClient || ++tries > 50) { clearInterval(poll); resolve(); }
                    }, 100);
                });
            }
            if (!window.supabaseClient) {
                content.innerHTML = '<div class="intel-loading" style="color:var(--text-secondary);"><i class="fa-solid fa-triangle-exclamation" style="color:#f59e0b;"></i> Sign in to load company intel.</div>';
                refreshBtn.disabled = false;
                return;
            }

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: `You are a company research assistant. Return ONLY a JSON array of 4-5 objects, each with "headline" (string, 8-15 words), "snippet" (string, 1 sentence of context a job applicant could reference in an outreach email), and "search_query" (string, a short Google search query to find the original article about this news item). Focus on recent news, product launches, funding, leadership changes, partnerships, awards, or notable company culture initiatives. If you don't have recent info, provide well-known facts about the company that would be useful conversation starters. No markdown, no explanation â€” ONLY the JSON array.` }] },
                        contents: [{ parts: [{ text: `Company: ${companyName}\nFind recent notable news, achievements, or developments about this company that a job applicant could reference in an introduction email.` }] }],
                        generationConfig: { temperature: 0.7 }
                    }
                });
                if (error) throw new Error(error.message);

                let text = data.candidates[0].content.parts[0].text.trim();
                // Strip markdown code fences if present
                text = text.replace(/^```json?\s*/i, '').replace(/\s*```$/i, '');
                const items = JSON.parse(text);
                renderIntel(items);
            } catch (e) {
                console.error('Intel fetch failed:', e);
                content.innerHTML = `<div class="intel-loading" style="color:var(--text-secondary);">
                    <i class="fa-solid fa-triangle-exclamation" style="color:#f59e0b;"></i> Couldn't load company intel.
                    <span style="font-size:0.75rem;display:block;margin-top:0.3rem;opacity:0.6;">${escapeHtml(e.message || 'Unknown error')}</span>
                    <button class="btn small-btn ghost-btn" style="margin-top:0.5rem;font-size:0.75rem;" onclick="fetchCompanyIntel()"><i class="fa-solid fa-rotate-right"></i> Retry</button>
                </div>`;
            } finally {
                refreshBtn.disabled = false;
            }
        }

        function renderIntel(items) {
            const content = document.getElementById('intel-content');
            const encoded = encodeURIComponent(companyName + ' news');

            let html = '<div class="intel-items">';
            items.forEach((item, i) => {
                const headline = escapeHtml(item.headline);
                const snippet = escapeHtml(item.snippet);
                const searchUrl = 'https://www.google.com/search?q=' + encodeURIComponent(item.search_query || item.headline);
                html += `<div class="intel-item">
                    <div class="intel-item-text"><a href="${searchUrl}" target="_blank" rel="noopener">${headline} <i class="fa-solid fa-arrow-up-right-from-square" style="font-size:0.6rem;opacity:0.5;"></i></a><br>${snippet}</div>
                    <button class="intel-insert-btn" onclick="insertIntel(${i})" title="Insert into email"><i class="fa-solid fa-plus"></i> Insert</button>
                </div>`;
            });
            html += '</div>';
            html += `<div class="intel-footer">
                <span style="font-size:0.75rem;color:var(--text-secondary);"><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:0.25rem;"></i>AI-generated â€” verify before sending</span>
                <a href="https://news.google.com/search?q=${encoded}" target="_blank" rel="noopener"><i class="fa-solid fa-arrow-up-right-from-square"></i> Google News</a>
            </div>`;
            content.innerHTML = html;

            // Store items for insert
            window._intelItems = items;
        }

        function insertIntel(index) {
            const item = window._intelItems?.[index];
            if (!item) return;
            const mention = `I was excited to see that ${item.snippet.charAt(0).toLowerCase() + item.snippet.slice(1)}`;

            // Insert at cursor position in contenteditable email card
            const emailCard = document.getElementById('email-card');
            emailCard.focus();
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const range = sel.getRangeAt(0);
                // Only insert inside the email card
                if (emailCard.contains(range.commonAncestorContainer)) {
                    range.deleteContents();
                    const node = document.createTextNode(mention);
                    range.insertNode(node);
                    range.setStartAfter(node);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else {
                    emailCard.innerHTML += `<p style="margin:0.4rem 0;">${escapeHtml(mention)}</p>`;
                }
            } else {
                emailCard.innerHTML += `<p style="margin:0.4rem 0;">${escapeHtml(mention)}</p>`;
            }

            // Visual feedback on button
            const btn = document.querySelectorAll('.intel-insert-btn')[index];
            if (btn) {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Added';
                btn.style.color = '#10b981';
                btn.style.borderColor = '#10b981';
                setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-plus"></i> Insert'; btn.style.color = ''; btn.style.borderColor = ''; }, 2000);
            }
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
    </script>
</body>

</html>