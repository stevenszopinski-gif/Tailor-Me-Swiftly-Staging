<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://pagead2.googlesyndication.com https://www.googletagmanager.com https://esm.sh https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; media-src 'self' https://*.supabase.co https://*.supabase.in blob:; connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co https://pagead2.googlesyndication.com https://*.google.com https://*.doubleclick.net https://gnews.io; frame-src https://js.stripe.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://tpc.googlesyndication.com;">
    <meta name="description"
        content="Generate your personalized AI news briefing. Enter your interests and get a curated digest in seconds.">
    <meta property="og:site_name" content="TailorMeSwiftly">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <title>New Briefing | TailorMeSwiftly</title>
    <link rel="stylesheet" href="../style.css?v=16">
    <link rel="stylesheet" href="news-style.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .briefing-body {
            line-height: 1.8;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Thesis opener ‚Äî the big bold takeaway */
        .briefing-body .briefing-thesis {
            font-size: 1.05rem;
            line-height: 1.6;
            padding: 1rem 1.25rem;
            margin: 0 0 1rem;
            background: color-mix(in srgb, var(--primary-color) 5%, transparent);
            border-left: 4px solid var(--primary-color);
            border-radius: 0 12px 12px 0;
        }

        .briefing-body .briefing-thesis strong {
            display: block;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--primary-color);
            margin-bottom: 0.4rem;
        }

        /* Flowing narrative paragraphs ‚Äî NOT carded */
        .briefing-body>p:not(.briefing-thesis) {
            margin: 0 0 1.25rem;
            font-size: 0.93rem;
            line-height: 1.85;
        }

        /* "What This Means For You" header */
        .briefing-body h3 {
            margin: 1.5rem 0 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        /* Actionable takeaways */
        .briefing-body ul {
            margin: 0.75rem 0;
            padding: 1.25rem 1.5rem 1.25rem 2.25rem;
            background: color-mix(in srgb, var(--primary-color) 4%, transparent);
            border: 1px solid color-mix(in srgb, var(--primary-color) 15%, transparent);
            border-radius: 12px;
            list-style-type: none;
        }

        .briefing-body li {
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .briefing-body li:last-child {
            margin-bottom: 0;
        }

        .briefing-body li::before {
            content: '';
            position: absolute;
            left: -0.9rem;
            top: 0.6rem;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary-color);
        }

        .briefing-body strong {
            color: var(--text-primary);
        }

        .briefing-cite {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0.85;
        }

        .briefing-cite:hover {
            text-decoration: underline;
            opacity: 1;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.6rem;
        }

        .briefing-source-card {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            padding: 0.75rem;
            border: 1px solid var(--panel-border);
            border-radius: 10px;
            text-decoration: none;
            color: inherit;
            font-size: 0.82rem;
            transition: border-color 0.2s, background 0.2s;
        }

        .briefing-source-card:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.04);
        }

        .briefing-source-card i {
            color: var(--primary-color);
            margin-top: 0.15rem;
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .source-name {
            font-weight: 600;
            font-size: 0.82rem;
            margin-bottom: 0.15rem;
        }

        .source-title {
            font-size: 0.78rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @media (max-width: 600px) {
            .sources-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body data-theme="light">
    <a href="#main-content" class="skip-nav">Skip to main content</a>
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <div class="app-container">
        <header class="app-header" role="banner">
            <div class="logo">
                <a href="../index.html"
                    style="display:flex;align-items:center;gap:0.5rem;text-decoration:none;color:inherit;">
                    <div class="logo-icon"><i class="fa-solid fa-clipboard"></i></div>
                    <h1>TailorMeSwiftly</h1>
                </a>
            </div>
            <div id="product-switcher" class="product-switcher"></div>
            <div class="header-actions" style="display:flex;gap:1rem;align-items:center;">
                <div id="user-profile"
                    style="display:none;flex-direction:column;align-items:center;gap:0.2rem;position:relative;">
                    <img id="user-avatar" aria-label="User menu" src="" alt="Avatar"
                        style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);cursor:pointer;"
                        onclick="document.getElementById('avatar-dropdown').classList.toggle('hidden')">
                    <span id="user-greeting"
                        style="font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;"></span>
                    <div id="avatar-dropdown" class="avatar-dropdown hidden"></div>
                </div>
            </div>
        </header>

        <main id="main-content" class="wizard-container glass-panel"
            style="max-width:800px;margin:2rem auto;padding:2rem;">
            <div style="margin-bottom:1.5rem;">
                <a href="../dashboard.html"
                    style="color:var(--text-secondary);text-decoration:none;font-size:0.85rem;"><i
                        class="fa-solid fa-arrow-left"></i> Dashboard</a>
            </div>

            <div class="step-header" style="text-align:left;margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                    <i class="fa-solid fa-wand-magic-sparkles" style="font-size:1.8rem;color:var(--primary-color);"></i>
                    <h2 style="margin:0;">New Briefing</h2>
                </div>
                <p>Tell us what you're interested in and we'll create a personalized news digest.</p>
            </div>

            <!-- Interest Input -->
            <div id="input-section">
                <!-- Tabs -->
                <div class="input-tabs">
                    <button class="input-tab active" data-tab="type" onclick="switchTab('type')">
                        <i class="fa-solid fa-keyboard"></i> Type Interests
                    </button>
                    <button class="input-tab" data-tab="resume" onclick="switchTab('resume')">
                        <i class="fa-solid fa-file-lines"></i> From Resume
                    </button>
                    <button class="input-tab" data-tab="jobs" onclick="switchTab('jobs')">
                        <i class="fa-solid fa-briefcase"></i> From Jobs
                    </button>
                </div>

                <!-- Tab A: Type Interests -->
                <div id="tab-type" class="news-tab-content active" style="margin-bottom: 0;">
                    <label for="interests-input"
                        style="font-weight:600;font-size:0.95rem;display:block;margin-bottom:0.4rem;">What topics
                        interest you?</label>
                    <textarea id="interests-input" rows="3"
                        placeholder="e.g. AI startups, climate change, NBA, cryptocurrency, space exploration..."
                        style="width:100%;padding:0.75rem 1rem;border-radius:10px;border:1px solid var(--panel-border);background:var(--input-bg);color:var(--text-primary);font-family:inherit;font-size:0.95rem;resize:vertical;"></textarea>
                    <p style="font-size:0.8rem;color:var(--text-secondary);margin-top:0.4rem;margin-bottom:0;">Separate
                        topics with
                        commas. Be as specific or broad as you like.</p>
                </div>

                <!-- Tab B: From Resume -->
                <div id="tab-resume" class="news-tab-content">
                    <p style="font-weight:600;font-size:0.95rem;margin-bottom:0.75rem;">Extract interests from your
                        resume</p>

                    <!-- TMS Import -->
                    <div id="tms-resume-section" style="margin-bottom:1.25rem;display:none;">
                        <button class="btn ghost-btn tms-import-btn" onclick="fetchTMSResume()" id="import-resume-btn">
                            <i class="fa-solid fa-link"></i> Use my TailorMeSwiftly resume
                        </button>
                        <div class="import-divider"><span>or upload a file</span></div>
                    </div>

                    <!-- File Upload -->
                    <div id="drop-zone" class="upload-zone" onclick="document.getElementById('file-input').click()"
                        ondragover="event.preventDefault();this.classList.add('dragover')"
                        ondragleave="this.classList.remove('dragover')"
                        ondrop="event.preventDefault();this.classList.remove('dragover');handleFile(event.dataTransfer.files[0])">
                        <i class="fa-solid fa-cloud-arrow-up"
                            style="font-size:2rem;color:var(--primary-color);margin-bottom:0.5rem;"></i>
                        <p style="margin:0;font-weight:500;">Drop your resume here or click to browse</p>
                        <p style="margin:0.25rem 0 0;font-size:0.8rem;color:var(--text-secondary);">PDF, DOCX, or TXT
                        </p>
                    </div>
                    <input type="file" id="file-input" accept=".pdf,.docx,.txt" style="display:none"
                        onchange="handleFile(this.files[0])">

                    <div id="file-status"
                        style="display:none;margin-top:0.75rem;font-size:0.85rem;color:var(--text-secondary);">
                        <i class="fa-solid fa-spinner fa-spin"></i> <span id="file-status-text">Parsing resume...</span>
                    </div>
                </div>

                <!-- Tab C: From Jobs -->
                <div id="tab-jobs" class="news-tab-content">
                    <p style="font-weight:600;font-size:0.95rem;margin-bottom:0.75rem;">Extract interests from your job
                        applications</p>

                    <div id="jobs-login-prompt" style="display:none;text-align:center;padding:1.5rem;">
                        <i class="fa-solid fa-lock"
                            style="font-size:1.5rem;color:var(--text-secondary);margin-bottom:0.5rem;display:block;"></i>
                        <p style="color:var(--text-secondary);margin-bottom:1rem;">Log in to access your TailorMeSwiftly
                            applications</p>
                        <a href="../login.html" class="btn primary-btn" style="font-size:0.9rem;"><i
                                class="fa-solid fa-right-to-bracket"></i> Log In</a>
                    </div>

                    <div id="jobs-loading" style="display:none;text-align:center;padding:1.5rem;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--primary-color);"></i>
                        <p style="color:var(--text-secondary);margin-top:0.5rem;">Loading your applications...</p>
                    </div>

                    <div id="jobs-empty" style="display:none;text-align:center;padding:1.5rem;">
                        <i class="fa-solid fa-folder-open"
                            style="font-size:1.5rem;color:var(--text-secondary);margin-bottom:0.5rem;display:block;"></i>
                        <p style="color:var(--text-secondary);margin-bottom:0.5rem;">No applications found</p>
                        <p style="color:var(--text-secondary);font-size:0.82rem;">Generate a tailored resume on <a
                                href="../app.html" style="color:var(--primary-color);">TailorMeSwiftly.com</a> first</p>
                    </div>

                    <div id="jobs-list" style="display:none;">
                        <div id="jobs-cards"
                            style="display:flex;flex-direction:column;gap:0.5rem;max-height:280px;overflow-y:auto;">
                        </div>
                        <button class="btn primary-btn" style="margin-top:1rem;width:100%;"
                            onclick="extractFromSelectedJobs()" id="extract-jobs-btn">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Extract Interests from Selected
                        </button>
                    </div>
                </div>

                <!-- Extracted Interest Tags (shared across tabs) -->
                <div id="interest-tags-section"
                    style="display:none;margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--panel-border);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <label style="font-weight:600;font-size:0.9rem;">Extracted Interests</label>
                        <span id="import-badge"
                            style="display:none;font-size:0.72rem;padding:0.2rem 0.6rem;border-radius:10px;background:rgba(59,130,246,0.1);color:var(--primary-color);"></span>
                    </div>
                    <div id="interest-tags" class="interest-tags-wrap"></div>
                    <div style="margin-top:0.5rem;">
                        <input type="text" id="add-interest-input" placeholder="Add a topic..."
                            style="padding:0.4rem 0.75rem;border-radius:8px;border:1px solid var(--panel-border);background:var(--input-bg);color:var(--text-primary);font-size:0.85rem;font-family:inherit;width:180px;"
                            onkeydown="if(event.key==='Enter'){addInterestTag(this.value);this.value='';}">
                    </div>
                </div>

                <!-- Extraction Loading -->
                <div id="extraction-loading" style="display:none;text-align:center;padding:1.5rem 0;">
                    <i class="fa-solid fa-brain"
                        style="font-size:1.5rem;color:var(--primary-color);margin-bottom:0.5rem;display:block;"></i>
                    <p style="color:var(--text-secondary);font-size:0.9rem;" id="extraction-status">Analyzing your
                        resume to identify interests...</p>
                </div>

                <div
                    style="margin-top:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center;background:var(--panel-bg);padding:1rem;border-radius:12px;border:1px solid var(--panel-border);">
                    <div style="flex:1;min-width:200px;">
                        <label for="briefing-tone"
                            style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.4rem;color:var(--text-secondary);">Briefing
                            Tone & Style</label>
                        <select id="briefing-tone"
                            style="width:100%;padding:0.6rem;border-radius:8px;border:1px solid var(--panel-border);background:var(--input-bg);color:var(--text-primary);font-size:0.9rem;">
                            <option value="npr">üéôÔ∏è NPR Morning Host (Audio-friendly)</option>
                            <option value="executive">üìä Executive Summary (Concise & Bulleted)</option>
                            <option value="deep-dive">üß† Deep Dive (Analytical & Thorough)</option>
                        </select>
                    </div>
                    <div>
                        <button id="generate-btn" class="btn primary-btn" onclick="generateBriefing()"
                            style="padding:0.6rem 1.5rem;">
                            <i class="fa-solid fa-bolt"></i> Generate Briefing
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-section" style="display:none;text-align:center;padding:3rem 0;">
                <div class="spinner"
                    style="margin:0 auto 1rem;width:48px;height:48px;border:3px solid var(--panel-border);border-top-color:var(--primary-color);border-radius:50%;animation:spin 0.8s linear infinite;">
                </div>
                <p id="loading-status" style="color:var(--text-secondary);">Fetching news articles...</p>
                <style>
                    @keyframes spin {
                        to {
                            transform: rotate(360deg);
                        }
                    }
                </style>
            </div>

            <!-- Result Section -->
            <div id="result-section" style="display:none;">
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;flex-wrap:wrap;gap:0.5rem;">
                    <h3 style="margin:0;"><i class="fa-solid fa-newspaper" style="color:var(--primary-color);"></i> What
                        You Need to Know</h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="briefing-read-time"
                            style="font-size:0.78rem;color:var(--text-secondary);padding:0.2rem 0.6rem;background:var(--panel-bg);border-radius:20px;border:1px solid var(--panel-border);"><i
                                class="fa-regular fa-clock" style="margin-right:0.3rem;"></i>‚Äî</span>
                        <button class="btn ghost-btn" style="font-size:0.82rem;" onclick="editInterests()">
                            <i class="fa-solid fa-pen"></i> Edit Interests
                        </button>
                    </div>
                </div>

                <div id="briefing-interests" style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1.25rem;">
                </div>

                <!-- Audio Player -->
                <div id="audio-section"
                    style="margin-bottom:1.5rem;padding:1rem;background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:12px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:0.75rem;">
                            <i class="fa-solid fa-microphone-lines"
                                style="font-size:1.2rem;color:var(--primary-color);"></i>
                            <div>
                                <div style="font-weight:600;font-size:0.9rem;">Listen to this briefing</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">AI-narrated news briefing
                                </div>
                            </div>
                        </div>
                        <button class="btn primary-btn" style="font-size:0.82rem;padding:0.4rem 1rem;"
                            onclick="listenToBriefing()" id="listen-btn">
                            <i class="fa-solid fa-play"></i> Listen
                        </button>
                    </div>
                    <div id="audio-container" style="display:none;margin-top:0.75rem;">
                        <audio id="briefing-audio" controls style="width:100%;border-radius:8px;"></audio>
                    </div>
                    <!-- Podcast Subscribe -->
                    <div id="podcast-subscribe"
                        style="display:none;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--panel-border);">
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.5rem;">Subscribe to
                            your briefings podcast:</div>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <a id="sub-apple" href="#" target="_blank" rel="noopener" class="btn ghost-btn"
                                style="font-size:0.72rem;padding:0.3rem 0.6rem;gap:0.3rem;text-decoration:none;">
                                <i class="fa-solid fa-podcast"></i> Apple Podcasts
                            </a>
                            <a id="sub-spotify" href="#" target="_blank" rel="noopener" class="btn ghost-btn"
                                style="font-size:0.72rem;padding:0.3rem 0.6rem;gap:0.3rem;text-decoration:none;">
                                <i class="fa-brands fa-spotify"></i> Spotify
                            </a>
                            <a id="sub-pocketcasts" href="#" target="_blank" rel="noopener" class="btn ghost-btn"
                                style="font-size:0.72rem;padding:0.3rem 0.6rem;gap:0.3rem;text-decoration:none;">
                                <i class="fa-solid fa-rss"></i> Pocket Casts
                            </a>
                            <button onclick="copyPodcastFeedUrl()" class="btn ghost-btn"
                                style="font-size:0.72rem;padding:0.3rem 0.6rem;gap:0.3rem;">
                                <i class="fa-solid fa-copy"></i> Copy RSS
                            </button>
                        </div>
                    </div>
                </div>

                <div id="briefing-content" class="briefing-body"></div>

                <div id="briefing-sources"
                    style="margin-top:2rem;padding-top:1.25rem;border-top:1px solid var(--panel-border);">
                    <h4 style="font-size:0.95rem;margin-bottom:0.75rem;color:var(--text-secondary);"><i
                            class="fa-solid fa-link" style="margin-right:0.4rem;"></i> Sources</h4>
                    <div id="sources-list" class="sources-grid"></div>
                </div>
            </div>
        </main>

        <footer class="site-footer" role="contentinfo"></footer>
    </div>

    <script>
        window.TMS_PATH_PREFIX = '../';
        // Early JWT alert interceptor ‚Äî must run before any library loads
        (function () {
            var o = window.alert;
            window.alert = function (m) {
                if (m && (String(m).toLowerCase().includes('jwt') || String(m).toLowerCase().includes('token') || String(m).includes('Session expired'))) {
                    console.warn('[JWT Intercept]', m);
                    sessionStorage.setItem('tms_redirect', window.location.href);
                    window.location.href = '../login.html?expired=true';
                    return;
                }
                return o.apply(this, arguments);
            };
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="../brand-config.js"></script>
    <script src="../auth.js?v=15"></script>
    <script src="../billing.js?v=1"></script>
    <script src="../components.js"></script>
    <script>
        let extractedInterests = [];
        let currentBriefingDate = null; // tracks which briefing is displayed
        let tmsApplications = [];

        // Edge Function helper ‚Äî bypasses sb_publishable_ key issue with supabaseClient.functions.invoke()
        const EDGE_FN_BASE = 'https://gwmpdgjvcjzndbloctla.supabase.co/functions/v1';

        async function invokeEdge(fnName, body) {
            // Use the global fresh-token helper from auth.js (refreshes if expired)
            const token = window._getFreshToken ? await window._getFreshToken() : (window._getAccessToken ? window._getAccessToken() : null);
            if (!token) {
                throw new Error('Please log in to continue.');
            }

            const resp = await fetch(`${EDGE_FN_BASE}/${fnName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'apikey': 'sb_publishable_Kor1B60TEAKofYE75aW7Ow_WL0cPOa8'
                },
                body: JSON.stringify(body)
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                const errMsg = data?.message || data?.error?.message || data?.error || `Edge function error (${resp.status})`;
                if (resp.status === 401 || errMsg.toLowerCase().includes('jwt') || errMsg.toLowerCase().includes('token')) {
                    console.warn('[invokeEdge] Auth invalid, redirecting directly', errMsg);
                    sessionStorage.setItem('tms_redirect', window.location.href);
                    window.location.href = '../login.html?expired=true';
                    // Return a never-resolving promise so execution stops here without throwing unhandled exceptions
                    return new Promise(() => { });
                }
                throw new Error(errMsg);
            }
            return data;
        }

        // PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ
        function switchTab(tab) {
            document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.news-tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');

            if (tab === 'jobs') loadTMSApplications();
            if (tab === 'resume') checkTMSResumeAvailable();
        }

        // ‚îÄ‚îÄ URL Params ‚îÄ‚îÄ
        (function () {
            const params = new URLSearchParams(window.location.search);
            const urlInterests = params.get('interests');
            if (urlInterests) {
                const tags = urlInterests.split(',').map(s => s.trim()).filter(Boolean);
                if (tags.length) {
                    extractedInterests = tags;
                    renderInterestTags(tags);
                    showImportBadge('Imported from TailorMeSwiftly');
                }
            }
        })();

        // ‚îÄ‚îÄ Load saved interests on auth ready ‚îÄ‚îÄ
        // Single config: if user has saved interests, auto-generate with those
        document.addEventListener('auth-ready', async () => {
            if (extractedInterests.length) return; // URL params take priority
            // Skip auto-generate if viewing a saved briefing
            if (new URLSearchParams(window.location.search).get('view')) return;
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) return;
                const { data: profile } = await window.supabaseClient
                    .from('user_profiles')
                    .select('interests')
                    .eq('user_id', session.user.id)
                    .maybeSingle();
                if (profile?.interests?.length) {
                    extractedInterests = profile.interests;
                    renderInterestTags(profile.interests);
                    // Auto-generate with saved config
                    generateBriefing();
                }
            } catch (e) { /* no saved interests */ }
        });

        // ‚îÄ‚îÄ File Upload & Parsing ‚îÄ‚îÄ
        async function handleFile(file) {
            if (!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            const statusEl = document.getElementById('file-status');
            const statusText = document.getElementById('file-status-text');
            statusEl.style.display = 'block';
            statusText.textContent = 'Parsing ' + file.name + '...';

            try {
                let text = '';
                if (ext === 'pdf') text = await extractTextFromPDF(file);
                else if (ext === 'docx') text = await extractTextFromDOCX(file);
                else if (ext === 'txt') text = await file.text();
                else throw new Error('Unsupported file type');

                if (!text.trim()) throw new Error('No text found in file');

                statusText.textContent = file.name + ' parsed successfully';
                statusEl.querySelector('i').className = 'fa-solid fa-check';
                statusEl.querySelector('i').style.color = 'var(--primary-color)';

                await extractInterestsFromText(text, 'resume');
            } catch (e) {
                statusText.textContent = e.message || 'Failed to parse file';
                statusEl.querySelector('i').className = 'fa-solid fa-xmark';
                statusEl.querySelector('i').style.color = '#ef4444';
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        // ‚îÄ‚îÄ TMS Resume Import ‚îÄ‚îÄ
        async function checkTMSResumeAvailable() {
            const section = document.getElementById('tms-resume-section');
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { section.style.display = 'none'; return; }

                const { data } = await window.supabaseClient
                    .from('generations')
                    .select('id')
                    .eq('user_id', session.user.id)
                    .not('resume_text', 'is', null)
                    .limit(1);

                section.style.display = (data?.length) ? 'block' : 'none';
            } catch (e) { section.style.display = 'none'; }
        }

        async function fetchTMSResume() {
            const btn = document.getElementById('import-resume-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Importing...';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) throw new Error('Not logged in');

                const { data } = await window.supabaseClient
                    .from('generations')
                    .select('resume_text')
                    .eq('user_id', session.user.id)
                    .not('resume_text', 'is', null)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();

                if (!data?.resume_text) throw new Error('No resume found in your TailorMeSwiftly account. Create an application first.');

                await extractInterestsFromText(data.resume_text, 'resume');
                showImportBadge('From TailorMeSwiftly resume');
            } catch (e) {
                alert(e.message || 'Failed to import resume');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-link"></i> Use my TailorMeSwiftly resume';
        }

        // ‚îÄ‚îÄ TMS Job Applications Import ‚îÄ‚îÄ
        async function loadTMSApplications() {
            const loginEl = document.getElementById('jobs-login-prompt');
            const loadingEl = document.getElementById('jobs-loading');
            const emptyEl = document.getElementById('jobs-empty');
            const listEl = document.getElementById('jobs-list');

            loginEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.style.display = 'none';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { loginEl.style.display = 'block'; return; }

                if (tmsApplications.length) { renderJobCards(); return; }

                loadingEl.style.display = 'block';

                const { data } = await window.supabaseClient
                    .from('generations')
                    .select('id, job_text, job_description, target_company, created_at')
                    .eq('user_id', session.user.id)
                    .not('job_text', 'is', null)
                    .order('created_at', { ascending: false })
                    .limit(20);

                loadingEl.style.display = 'none';

                if (!data?.length) { emptyEl.style.display = 'block'; return; }

                tmsApplications = data;
                renderJobCards();
            } catch (e) {
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }

        function renderJobCards() {
            const container = document.getElementById('jobs-cards');
            container.innerHTML = tmsApplications.map((app, i) => {
                const company = app.target_company || 'Unknown Company';
                const date = new Date(app.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const preview = (app.job_text || '').substring(0, 80).replace(/<[^>]+>/g, '') + '...';
                return `<label class="job-card">
                    <input type="checkbox" value="${i}" class="job-checkbox">
                    <div class="job-card-content">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong style="font-size:0.9rem;">${company}</strong>
                            <span style="font-size:0.75rem;color:var(--text-secondary);">${date}</span>
                        </div>
                        <p style="font-size:0.8rem;color:var(--text-secondary);margin:0.25rem 0 0;line-height:1.4;">${preview}</p>
                    </div>
                </label>`;
            }).join('');
            document.getElementById('jobs-list').style.display = 'block';
        }

        async function extractFromSelectedJobs() {
            const checked = [...document.querySelectorAll('.job-checkbox:checked')].map(c => parseInt(c.value));
            if (!checked.length) { alert('Select at least one application'); return; }

            const btn = document.getElementById('extract-jobs-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Extracting...';

            const combinedText = checked.map(i => {
                const app = tmsApplications[i];
                return `Company: ${app.target_company || 'Unknown'}\nJob Description: ${app.job_text || app.job_description || ''}`;
            }).join('\n\n---\n\n');

            await extractInterestsFromText(combinedText, 'job applications');
            showImportBadge('From ' + checked.length + ' TailorMeSwiftly application' + (checked.length > 1 ? 's' : ''));

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Extract Interests from Selected';
        }

        // ‚îÄ‚îÄ AI Interest Extraction ‚îÄ‚îÄ
        async function extractInterestsFromText(text, sourceType) {
            const loadingEl = document.getElementById('extraction-loading');
            const statusEl = document.getElementById('extraction-status');
            loadingEl.style.display = 'block';
            statusEl.textContent = `Analyzing your ${sourceType} to identify interests...`;

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { throw new Error('Please log in to continue.'); }

                const systemPrompt = `You are an interest extraction engine. Given a ${sourceType}, extract 5-10 news topics the person would likely want to follow.

RULES:
- Return ONLY a valid JSON array of short topic strings
- Focus on: industry sectors, technologies, skills, companies, market trends
- Be specific enough to find relevant news (e.g. "cloud computing" not just "technology")
- Avoid generic terms like "work" or "career"
- No explanation, just the JSON array

Example output: ["AI/ML", "cloud computing", "fintech", "React", "startup funding"]`;

                const data = await invokeEdge('gemini-proxy', {
                    contents: [{ parts: [{ text: text.substring(0, 8000) }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.3, maxOutputTokens: 1024, thinkingConfig: { thinkingBudget: 0 } }
                });
                if (data?.error) throw new Error(data.error.message || 'AI extraction failed');
                // Concatenate all non-thinking text parts
                const extractParts = data.candidates?.[0]?.content?.parts || [];
                const raw = extractParts.filter(p => !p.thought && p.text).map(p => p.text).join('') || '[]';
                console.log('[extract] Raw response:', raw.substring(0, 500));
                // Parse JSON from response (handle markdown code blocks)
                const jsonStr = raw.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
                let interests = [];
                try {
                    const arrayMatch = jsonStr.match(/\[[\s\S]*?\]/);
                    interests = JSON.parse(arrayMatch ? arrayMatch[0] : jsonStr);
                } catch (e) {
                    // Fallback: simply split by newlines or commas if it returned a list
                    interests = raw.replace(/```json?\n?/g, '').replace(/```/g, '')
                        .replace(/[\[\]"]/g, '').split(/,|\n/)
                        .map(s => s.trim().replace(/^- /, ''))
                        .filter(Boolean);
                }

                if (!Array.isArray(interests) || !interests.length) throw new Error('No interests extracted');

                extractedInterests = interests.map(s => String(s).trim()).filter(Boolean).slice(0, 10);
                renderInterestTags(extractedInterests);
                saveInterestsToProfile(extractedInterests);

            } catch (e) {
                console.error('Extraction error:', e);
                const statusEl = document.getElementById('extraction-status');
                statusEl.innerHTML = `<span style="color:var(--error-color)"><i class="fa-solid fa-triangle-exclamation"></i> Could not extract interests automatically. Please type them below.</span>`;
            }

            loadingEl.style.display = 'none';
        }

        // ‚îÄ‚îÄ Interest Tags UI ‚îÄ‚îÄ
        function renderInterestTags(interests) {
            const section = document.getElementById('interest-tags-section');
            const container = document.getElementById('interest-tags');
            section.style.display = 'block';
            container.innerHTML = interests.map((tag, i) =>
                `<span class="interest-tag editable">${tag} <button onclick="removeInterestTag(${i})" aria-label="Remove ${tag}">&times;</button></span>`
            ).join('');

            // Also sync to textarea for the generate function
            document.getElementById('interests-input').value = interests.join(', ');
        }

        function removeInterestTag(index) {
            extractedInterests.splice(index, 1);
            renderInterestTags(extractedInterests);
            if (!extractedInterests.length) {
                document.getElementById('interest-tags-section').style.display = 'none';
            }
        }

        function addInterestTag(val) {
            val = val.trim();
            if (!val || extractedInterests.includes(val)) return;
            extractedInterests.push(val);
            renderInterestTags(extractedInterests);
        }

        function showImportBadge(text) {
            const badge = document.getElementById('import-badge');
            badge.textContent = text;
            badge.style.display = 'inline-block';
        }

        // ‚îÄ‚îÄ Save/Load Interests ‚îÄ‚îÄ
        async function saveInterestsToProfile(interests) {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) return;
                await window.supabaseClient.from('user_profiles')
                    .update({ interests })
                    .eq('user_id', session.user.id);
            } catch (e) { /* silent */ }
        }

        // ‚îÄ‚îÄ Generate & Edit Briefing Flow ‚îÄ‚îÄ
        function editInterests() {
            // Hide result, show input
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('input-section').style.display = 'block';

            // Sync the tags UI and textarea with whatever the user currently sees or last generated
            renderInterestTags(extractedInterests || []);

            // Switch to Type Interests tab by default when editing so they clearly see the text box
            switchTab('type');
        }

        async function generateBriefing() {
            // Unify interests: Textarea is the absolute source of truth if they are on Tab A,
            // otherwise `extractedInterests` is the source of truth if they just extracted.
            const typeTabActive = document.getElementById('tab-type').classList.contains('active');
            let interests = [];

            if (typeTabActive) {
                const textVal = document.getElementById('interests-input').value.trim();
                interests = textVal ? textVal.split(',').map(s => s.trim()).filter(Boolean) : [];
                // Sync back to tags
                extractedInterests = [...interests];
            } else {
                interests = [...extractedInterests];
            }

            if (!interests.length) { alert('Please enter or extract some interests first.'); return; }

            // Sync tags UI for the Edit screen later
            renderInterestTags(interests);

            document.getElementById('input-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) {
                    throw new Error('Please log in to generate a briefing.');
                }

                // Step 1: Fetch news
                document.getElementById('loading-status').textContent = 'Fetching news articles...';
                const newsData = await invokeEdge('fetch-news', { interests, max: 10, skipCache: true });

                if (!newsData?.articles?.length) {
                    throw new Error('No articles found for those topics. Try different or broader interests.');
                }

                const articles = newsData.articles;

                // Step 2: Generate briefing via Gemini
                document.getElementById('loading-status').textContent = 'Generating your personalized briefing...';

                const tone = document.getElementById('briefing-tone')?.value || 'npr';
                let systemPrompt = '';

                if (tone === 'executive') {
                    systemPrompt = `You are a top-tier executive assistant providing a concise, high-signal news summary.

CRITICAL INSTRUCTION (Knowles' Andragogical Principles):
You MUST tailor this briefing specifically to the user's role and interests using adult learning principles:
1. Relevance: Explicitly state the strategic importance of each story to their specific career/industry.
2. Problem-Centric: Focus on risks to mitigate or opportunities to capture.
3. Immediate Value: Provide highly actionable, bulleted takeaways.

TARGET LENGTH: 300-400 words (Hyper-concise).

VOICE & TONE:
- Professional, direct, and zero-fluff.
- Use bullet points extensively for quick scanning.
- Bold key metrics, companies, and actionable verbs.

STRUCTURE & FORMAT (use exactly this HTML):
<p class="briefing-thesis"><strong>EXECUTIVE SUMMARY:</strong> A one-sentence bottom-line up front (BLUF) covering the most critical development today.</p>
<h3>Strategic Impact:</h3>
<ul><li><strong>[Topic/Company]:</strong> 1-2 sentences on the news. <a href="ARTICLE_URL" target="_blank" rel="noopener" class="briefing-cite">[Source]</a></li></ul>
<h3>Market & Industry Updates:</h3>
<ul><li><strong>[Topic/Company]:</strong> 1 sentence summary. <a href="ARTICLE_URL" target="_blank" rel="noopener" class="briefing-cite">[Source]</a></li></ul>
<h3>Action Items:</h3>
<ul><li><strong>Verb-first action:</strong> What the user needs to do based on this intelligence.</li></ul>`;
                } else if (tone === 'deep-dive') {
                    systemPrompt = `You are an expert industry analyst writing an in-depth intelligence brief.

CRITICAL INSTRUCTION (Knowles' Andragogical Principles):
You MUST tailor this briefing specifically to the user's role and interests using adult learning principles:
1. Relevance: Unpack the *second-order effects* and long-term implications of the news on their specific career/industry.
2. Experience: Assume the user is a knowledgeable professional; do not explain basic concepts. Focus on advanced analysis.
3. Problem-Centric: Provide deep context to help them navigate complex industry shifts.

TARGET LENGTH: 700-900 words (Comprehensive analysis).

VOICE & TONE:
- Analytical, authoritative, and deeply investigative.
- Connect dots between different news stories to show macro-trends.
- Write in well-structured paragraphs.

STRUCTURE & FORMAT (use exactly this HTML):
<p class="briefing-thesis"><strong>INTELLIGENCE BRIEF:</strong> A 2-3 sentence overview of the macro-theme tying today's news together.</p>
<h3>Deep Analysis: The Main Story:</h3>
<p>2-3 rigorous paragraphs analyzing the biggest news item, its background, and its specific second-order implications for the user's industry. <a href="ARTICLE_URL" target="_blank" rel="noopener" class="briefing-cite">[Source]</a></p>
<h3>Connecting the Dots:</h3>
<p>1-2 paragraphs synthesizing the remaining news items into a cohesive trend narrative. <a href="ARTICLE_URL" target="_blank" rel="noopener" class="briefing-cite">[Source]</a></p>
<h3>Strategic Recommendations:</h3>
<ul><li><strong>Long-term view:</strong> What the user should plan for over the next 6-12 months based on this data.</li></ul>`;
                } else {
                    // Default NPR
                    systemPrompt = `You are an NPR morning briefing host ‚Äî warm, smart, and conversational. You're writing a script that will be READ ALOUD by a TTS voice AND displayed as a visual article. It must sound natural spoken AND look great on screen.

CRITICAL INSTRUCTION (Knowles' Andragogical Principles):
You MUST tailor this briefing specifically to the user's role and interests using adult learning principles:
1. Relevance: Explicitly tell them *why* each story matters to their specific career/industry right now.
2. Problem-Centric: Frame the news around challenges they face and how this information helps solve them.
3. Experience: Connect the news to their probable professional baseline based on their stated interests.
4. Immediate Value: Focus heavily on what they can or should do with this information today.

TARGET LENGTH: 500-650 words (2-3 minute read / ~3 min audio).

VOICE & TONE:
- Write exactly how an NPR host talks: natural transitions, conversational phrasing, smooth cadence
- Address the listener directly ‚Äî "you", "your", "here's what you need to know"
- Use short, spoken-rhythm sentences. Vary length for flow. Avoid walls of text.
- Sound like you're talking TO someone, not reading AT them
- Bold key names, numbers, and facts for visual scanning (the TTS will ignore formatting)
- NO parentheses, abbreviations, or symbols that sound awkward read aloud. Write "percent" not "%", "dollar" not "$"

STRUCTURE (use ALL sections in this order):
1. OPENING ‚Äî A warm, hooky 1-2 sentence opener that pulls the listener in. Think "Good morning ‚Äî here's something that might change your week."
2. THE BIG STORY ‚Äî 2-3 short paragraphs telling the main narrative. Explicitly state WHY this impacts their specific work. Use transitions ("Here's why that matters to you..."). Keep paragraphs to 2-3 sentences.
3. WHAT ELSE IS HAPPENING ‚Äî 2-4 quick-hit items. Each is a mini-story in 1-2 sentences with a bold visual lead-in but written to flow naturally when read aloud. Briefly tie each to their interests.
4. YOUR TAKEAWAY ‚Äî 2-3 direct, actionable points written as advice. Start with verbs. ("Watch for...", "Keep an eye on...", "Consider...")

FORMAT ‚Äî use this EXACT HTML:
- Opener: <p class="briefing-thesis"><strong>TODAY'S BRIEFING:</strong> Your hooky opening line here.</p>
- Section headers: <h3>The Big Story:</h3>, <h3>What Else Is Happening:</h3>, <h3>Your Takeaway:</h3>
- Body: <p>Short paragraphs. Use <strong>bold</strong> for key facts. Cite sources with <a href="ARTICLE_URL" target="_blank" rel="noopener" class="briefing-cite">[Source Name]</a>.</p>
- Quick hits: <ul><li><strong>Bold lead-in:</strong> One-two sentence summary with citation.</li></ul>
- Takeaways: <ul><li>Actionable problem-solving advice starting with a verb</li></ul>
- Use the exact article URL provided for each source link
- No <html>, <body>, or <head> tags
- CRITICAL: Write so every sentence sounds natural when read aloud. No jargon, no awkward constructions, no run-on sentences.`;
                }

                const articleSummaries = articles.map(a =>
                    `Title: ${a.title}\nSource: ${a.source}\nDate: ${a.publishedAt}\nDescription: ${a.description}\nURL: ${a.url}`
                ).join('\n\n---\n\n');

                const userPrompt = `Create a personalized news briefing for someone interested in: ${interests.join(', ')}\n\nHere are today's relevant articles:\n\n${articleSummaries}`;

                const geminiData = await invokeEdge('gemini-proxy', {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.7, maxOutputTokens: 4096, thinkingConfig: { thinkingBudget: 1024 } },
                    skipCache: true
                });
                if (geminiData?.error) throw new Error(geminiData.error.message || 'AI generation failed');
                // Gemini 2.5 may return thinking parts ‚Äî find the non-thinking part
                const geminiParts = geminiData.candidates?.[0]?.content?.parts || [];
                const finishReason = geminiData.candidates?.[0]?.finishReason;
                console.log('[briefing] finishReason:', finishReason, 'parts:', geminiParts.length);
                // Concatenate all non-thinking text parts (Gemini may split output across multiple parts)
                const textParts = geminiParts.filter(p => !p.thought && p.text);
                const briefingHtml = textParts.map(p => p.text).join('') || 'No briefing generated.';

                // Step 3: Save to DB
                await window.supabaseClient.from('daily_briefings').upsert({
                    user_id: session.user.id,
                    briefing_date: new Date().toISOString().split('T')[0],
                    interests: interests,
                    briefing_html: briefingHtml,
                    briefing_text: briefingHtml.replace(/<[^>]+>/g, ''),
                    audio_url: null,
                    sources: articles.map(a => ({ title: a.title, url: a.url, source: a.source, publishedAt: a.publishedAt })),
                    metadata: { model: 'gemini-3-flash-preview', generated_at: new Date().toISOString() }
                }, { onConflict: 'user_id,briefing_date' });

                currentBriefingDate = new Date().toISOString().split('T')[0];
                _skipCachedAudio = false; // Reset so fresh audio can be cached

                // Save interests to profile for next time
                saveInterestsToProfile(interests);

                // Step 4: Display result
                showBriefing(briefingHtml, interests, articles);

            } catch (e) {
                console.error('Briefing error:', e);
                const msg = e.message || 'Failed to generate briefing. Please try again.';

                document.getElementById('loading-section').style.display = 'none';
                document.getElementById('input-section').style.display = 'block';

                // Display error inline instead of redirecting
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-text';
                errorDiv.style.marginTop = '1rem';
                errorDiv.style.textAlign = 'center';
                errorDiv.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}`;

                const existingErr = document.querySelector('#input-section .error-text');
                if (existingErr) existingErr.remove();
                document.getElementById('input-section').appendChild(errorDiv);
            }
        }

        function showBriefing(html, interests, articles) {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';

            const tagsEl = document.getElementById('briefing-interests');
            tagsEl.innerHTML = interests.map(i => `<span class="interest-tag">${i}</span>`).join('');

            // Calculate estimated read time
            const plainText = html.replace(/<[^>]+>/g, '');
            const wordCount = plainText.trim().split(/\s+/).length;
            const readMin = Math.max(1, Math.round(wordCount / 200));
            document.getElementById('briefing-read-time').textContent = `${readMin} min read`;

            // Post-process: convert plain [Source: name] text into clickable links
            let processedHtml = html;
            if (articles && articles.length) {
                // Build a lookup map from source name to URL
                const sourceMap = {};
                articles.forEach(a => {
                    if (a.source) sourceMap[a.source.toLowerCase()] = a.url;
                    if (a.title) sourceMap[a.title.toLowerCase()] = a.url;
                });
                // Replace [Source: name] with clickable links
                processedHtml = processedHtml.replace(/\[Source:\s*([^\]]+)\]/gi, (match, name) => {
                    const key = name.trim().toLowerCase();
                    const url = sourceMap[key];
                    if (url) return `<a href="${url}" target="_blank" rel="noopener" class="briefing-cite">[${name.trim()}]</a>`;
                    return `<span class="briefing-cite">[${name.trim()}]</span>`;
                });
            }
            document.getElementById('briefing-content').innerHTML = processedHtml;
            setupPodcastSubscribe();

            const srcEl = document.getElementById('sources-list');
            srcEl.innerHTML = articles.map(a => {
                const url = a.url || '#';
                const name = a.source || a.title || 'Source';
                const title = a.title || '';
                return `<a href="${url}" target="_blank" rel="noopener" class="briefing-source-card">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    <div>
                        <div class="source-name">${name}</div>
                        ${title ? `<div class="source-title">${title}</div>` : ''}
                    </div>
                </a>`;
            }).join('');
        }

        // ‚îÄ‚îÄ Podcast Subscribe Links ‚îÄ‚îÄ
        async function setupPodcastSubscribe() {
            try {
                // Wait for supabaseClient if not ready yet
                if (!window.supabaseClient) {
                    await new Promise(r => {
                        let tries = 0;
                        const poll = setInterval(() => {
                            if (window.supabaseClient || ++tries > 50) { clearInterval(poll); r(); }
                        }, 100);
                    });
                }
                if (!window.supabaseClient) return;

                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) return;

                const feedUrl = `https://gwmpdgjvcjzndbloctla.supabase.co/functions/v1/podcast-feed?uid=${session.user.id}`;

                document.getElementById('sub-apple').href = `podcast://${feedUrl.replace('https://', '')}`;
                document.getElementById('sub-spotify').href = `https://open.spotify.com/show/import?url=${encodeURIComponent(feedUrl)}`;
                document.getElementById('sub-pocketcasts').href = `https://pca.st/feed/${encodeURIComponent(feedUrl)}`;

                window._podcastFeedUrl = feedUrl;
                document.getElementById('podcast-subscribe').style.display = 'block';
                console.log('[subscribe] Podcast subscribe links ready');
            } catch (e) { console.warn('Subscribe setup failed:', e); }
        }

        function copyPodcastFeedUrl() {
            if (!window._podcastFeedUrl) return;
            navigator.clipboard.writeText(window._podcastFeedUrl).then(() => {
                const btn = event.target.closest('button');
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = orig, 2000);
            }).catch(() => alert(window._podcastFeedUrl));
        }

        // ‚îÄ‚îÄ View Mode: load a saved briefing from feed ‚îÄ‚îÄ
        (async function checkViewMode() {
            const params = new URLSearchParams(window.location.search);
            const viewId = params.get('view');
            if (!viewId) return;

            // Try sessionStorage first (set by feed.html)
            let briefing = null;
            try {
                const cached = sessionStorage.getItem('ttn_view_briefing');
                if (cached) briefing = JSON.parse(cached);
            } catch (e) { }

            // If not cached or wrong ID, fetch from DB
            if (!briefing || briefing.id !== viewId) {
                // Wait for supabase
                if (!window.supabaseClient) {
                    await new Promise(r => {
                        let tries = 0;
                        const poll = setInterval(() => {
                            if (window.supabaseClient || ++tries > 80) { clearInterval(poll); r(); }
                        }, 100);
                    });
                }
                if (!window.supabaseClient) return;
                const { data } = await window.supabaseClient.from('daily_briefings').select('*').eq('id', viewId).single();
                if (data) briefing = data;
            }

            if (!briefing) return;

            currentBriefingDate = briefing.briefing_date;

            // Display the saved briefing
            const interests = briefing.interests || [];
            const sources = briefing.sources || [];
            const html = briefing.briefing_html || briefing.briefing_text || '';

            document.getElementById('input-section').style.display = 'none';
            showBriefing(html, interests, sources);
        })();

        function extractBriefingText() {
            const content = document.getElementById('briefing-content');
            if (!content || !content.textContent.trim()) return '';
            const text = content.textContent.replace(/\[.*?\]/g, '').trim();
            console.log('[tts] extractBriefingText length:', text.length, 'chars, first 200:', text.substring(0, 200));
            return text;
        }

        // ‚îÄ‚îÄ Audio Playback ‚îÄ‚îÄ
        let _skipCachedAudio = false; // set true when cached URL fails so retry generates fresh

        function playAudioUrl(url) {
            const audioContainer = document.getElementById('audio-container');
            if (!audioContainer) { console.error('audio-container not found'); return; }

            // Re-create the audio element in case a previous error destroyed it
            audioContainer.innerHTML = '<audio id="briefing-audio" controls style="width:100%;border-radius:8px;"></audio>';
            const audioEl = document.getElementById('briefing-audio');

            audioEl.onerror = async function () {
                console.error('Audio load failed:', url);
                _skipCachedAudio = true;
                // Clear the broken cached URL from DB
                try {
                    const { data: { session } } = await window.supabaseClient.auth.getSession();
                    if (session && currentBriefingDate) {
                        await window.supabaseClient.from('daily_briefings')
                            .update({ audio_url: null })
                            .eq('user_id', session.user.id)
                            .eq('briefing_date', currentBriefingDate);
                    }
                } catch (e) { console.warn('Failed to clear cached URL:', e); }

                audioContainer.innerHTML = '<div style="padding:0.75rem;color:var(--text-secondary);font-size:0.85rem;">' +
                    '<i class="fa-solid fa-exclamation-triangle" style="color:#e74c3c;margin-right:0.4rem;"></i>' +
                    'Cached audio expired. Click <b>Listen</b> to generate fresh audio.</div>';
                const btn = document.getElementById('listen-btn');
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-play"></i> Listen'; }
            };

            audioEl.src = url;
            audioContainer.style.display = 'block';
            audioEl.play().catch(() => { /* autoplay blocked */ });

            const btn = document.getElementById('listen-btn');
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-pause"></i> Playing'; }
        }

        async function listenToBriefing() {
            const btn = document.getElementById('listen-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) throw new Error('Please sign in to use audio.');

                // Check for cached audio URL (skip if previous cached URL failed)
                // Also validate the cached audio matches current briefing content
                const currentText = extractBriefingText();
                if (currentBriefingDate && !_skipCachedAudio) {
                    const { data: row } = await window.supabaseClient
                        .from('daily_briefings')
                        .select('audio_url, briefing_text')
                        .eq('user_id', session.user.id)
                        .eq('briefing_date', currentBriefingDate)
                        .single();

                    if (row?.audio_url && row.audio_url.startsWith('http')) {
                        // Verify cached audio is for the current briefing text (not stale from old content)
                        const storedText = (row.briefing_text || '').substring(0, 100);
                        const displayText = (currentText || '').substring(0, 100);
                        if (storedText && displayText && storedText === displayText) {
                            playAudioUrl(row.audio_url);
                            return;
                        }
                        // Text mismatch ‚Äî cached audio is stale, clear it
                        console.log('[tts] Cached audio is stale (text mismatch), regenerating');
                        await window.supabaseClient.from('daily_briefings')
                            .update({ audio_url: null })
                            .eq('user_id', session.user.id)
                            .eq('briefing_date', currentBriefingDate);
                    }
                }

                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating audio<span id="tts-dots">.</span>';
                const dotsInterval = setInterval(() => {
                    const dots = document.getElementById('tts-dots');
                    if (dots) dots.textContent = dots.textContent.length >= 3 ? '.' : dots.textContent + '.';
                }, 800);

                const briefingText = currentText || extractBriefingText();
                if (!briefingText || briefingText.length < 50) throw new Error('No briefing content to narrate.');

                const result = await invokeEdge('podcastfy', { text: briefingText.substring(0, 5000) });
                clearInterval(dotsInterval);

                if (result?.error) throw new Error(result.error);
                console.log('[tts] Result:', JSON.stringify(result));
                if (!result?.audioUrl) throw new Error('No audio generated. Please try again.');

                // Cache the audio URL
                _skipCachedAudio = false;
                if (currentBriefingDate) {
                    try {
                        await window.supabaseClient
                            .from('daily_briefings')
                            .update({ audio_url: result.audioUrl })
                            .eq('user_id', session.user.id)
                            .eq('briefing_date', currentBriefingDate);
                    } catch (cacheErr) {
                        console.warn('Failed to cache audio URL:', cacheErr);
                    }
                }

                playAudioUrl(result.audioUrl);
            } catch (e) {
                console.error('TTS error:', e);
                alert(e.message || 'Audio generation failed. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-play"></i> Listen';
            }
        }
    </script>
</body>

</html>