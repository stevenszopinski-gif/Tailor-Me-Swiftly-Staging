<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://pagead2.googlesyndication.com https://www.googletagmanager.com https://esm.sh https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co https://pagead2.googlesyndication.com https://api.elevenlabs.io https://gnews.io; frame-src https://js.stripe.com https://pagead2.googlesyndication.com;">
    <meta name="description"
        content="Generate your personalized AI news briefing. Enter your interests and get a curated digest in seconds.">
    <meta property="og:site_name" content="TailorMeSwiftly">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <title>New Briefing | TailorMeSwiftly</title>
    <link rel="stylesheet" href="../style.css?v=16">
    <link rel="stylesheet" href="news-style.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .briefing-body {
            line-height: 1.8;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Thesis opener — the big bold takeaway */
        .briefing-body .briefing-thesis {
            font-size: 1.05rem;
            line-height: 1.6;
            padding: 1.25rem 1.5rem;
            margin: 0 0 1.5rem;
            background: color-mix(in srgb, var(--primary-color) 5%, transparent);
            border-left: 4px solid var(--primary-color);
            border-radius: 0 12px 12px 0;
        }

        .briefing-body .briefing-thesis strong {
            display: block;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--primary-color);
            margin-bottom: 0.4rem;
        }

        /* Flowing narrative paragraphs — NOT carded */
        .briefing-body>p:not(.briefing-thesis) {
            margin: 0 0 1.25rem;
            font-size: 0.93rem;
            line-height: 1.85;
        }

        /* "What This Means For You" header */
        .briefing-body h3 {
            margin: 2.5rem 0 1rem;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        /* Actionable takeaways */
        .briefing-body ul {
            margin: 0.75rem 0;
            padding: 1.25rem 1.5rem 1.25rem 2.25rem;
            background: color-mix(in srgb, var(--primary-color) 4%, transparent);
            border: 1px solid color-mix(in srgb, var(--primary-color) 15%, transparent);
            border-radius: 12px;
            list-style-type: none;
        }

        .briefing-body li {
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .briefing-body li:last-child {
            margin-bottom: 0;
        }

        .briefing-body li::before {
            content: '';
            position: absolute;
            left: -0.9rem;
            top: 0.6rem;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary-color);
        }

        .briefing-body strong {
            color: var(--text-primary);
        }

        .briefing-cite {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0.85;
        }

        .briefing-cite:hover {
            text-decoration: underline;
            opacity: 1;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.6rem;
        }

        .briefing-source-card {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            padding: 0.75rem;
            border: 1px solid var(--panel-border);
            border-radius: 10px;
            text-decoration: none;
            color: inherit;
            font-size: 0.82rem;
            transition: border-color 0.2s, background 0.2s;
        }

        .briefing-source-card:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.04);
        }

        .briefing-source-card i {
            color: var(--primary-color);
            margin-top: 0.15rem;
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .source-name {
            font-weight: 600;
            font-size: 0.82rem;
            margin-bottom: 0.15rem;
        }

        .source-title {
            font-size: 0.78rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @media (max-width: 600px) {
            .sources-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body data-theme="light">
    <a href="#main-content" class="skip-nav">Skip to main content</a>
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <div class="app-container">
        <header class="app-header" role="banner">
            <div class="logo">
                <a href="../index.html"
                    style="display:flex;align-items:center;gap:0.5rem;text-decoration:none;color:inherit;">
                    <div class="logo-icon"><i class="fa-solid fa-clipboard"></i></div>
                    <h1>TailorMeSwiftly</h1>
                </a>
            </div>
            <div id="product-switcher" class="product-switcher"></div>
            <div class="header-actions" style="display:flex;gap:1rem;align-items:center;">
                <div id="user-profile"
                    style="display:none;flex-direction:column;align-items:center;gap:0.2rem;position:relative;">
                    <img id="user-avatar" aria-label="User menu" src="" alt="Avatar"
                        style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);cursor:pointer;"
                        onclick="document.getElementById('avatar-dropdown').classList.toggle('hidden')">
                    <span id="user-greeting"
                        style="font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;"></span>
                    <div id="avatar-dropdown" class="avatar-dropdown hidden"></div>
                </div>
            </div>
        </header>

        <main id="main-content" class="wizard-container glass-panel"
            style="max-width:800px;margin:2rem auto;padding:2rem;">
            <div style="margin-bottom:1.5rem;">
                <a href="feed.html" style="color:var(--text-secondary);text-decoration:none;font-size:0.85rem;"><i
                        class="fa-solid fa-arrow-left"></i> My Briefings</a>
            </div>

            <div class="step-header" style="text-align:left;margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                    <i class="fa-solid fa-wand-magic-sparkles" style="font-size:1.8rem;color:var(--primary-color);"></i>
                    <h2 style="margin:0;">New Briefing</h2>
                </div>
                <p>Tell us what you're interested in and we'll create a personalized news digest.</p>
            </div>

            <!-- Interest Input -->
            <div id="input-section">
                <!-- Tabs -->
                <div class="input-tabs">
                    <button class="input-tab active" data-tab="type" onclick="switchTab('type')">
                        <i class="fa-solid fa-keyboard"></i> Type Interests
                    </button>
                    <button class="input-tab" data-tab="resume" onclick="switchTab('resume')">
                        <i class="fa-solid fa-file-lines"></i> From Resume
                    </button>
                    <button class="input-tab" data-tab="jobs" onclick="switchTab('jobs')">
                        <i class="fa-solid fa-briefcase"></i> From Jobs
                    </button>
                </div>

                <!-- Tab A: Type Interests -->
                <div id="tab-type" class="tab-content active">
                    <label for="interests-input"
                        style="font-weight:600;font-size:0.95rem;display:block;margin-bottom:0.5rem;">What topics
                        interest you?</label>
                    <textarea id="interests-input" rows="3"
                        placeholder="e.g. AI startups, climate change, NBA, cryptocurrency, space exploration..."
                        style="width:100%;padding:1rem;border-radius:10px;border:1px solid var(--panel-border);background:var(--input-bg);color:var(--text-primary);font-family:inherit;font-size:0.95rem;resize:vertical;"></textarea>
                    <p style="font-size:0.8rem;color:var(--text-secondary);margin-top:0.5rem;">Separate topics with
                        commas. Be as specific or broad as you like.</p>
                </div>

                <!-- Tab B: From Resume -->
                <div id="tab-resume" class="tab-content">
                    <p style="font-weight:600;font-size:0.95rem;margin-bottom:0.75rem;">Extract interests from your
                        resume</p>

                    <!-- TMS Import -->
                    <div id="tms-resume-section" style="margin-bottom:1.25rem;display:none;">
                        <button class="btn ghost-btn tms-import-btn" onclick="fetchTMSResume()" id="import-resume-btn">
                            <i class="fa-solid fa-link"></i> Use my TailorMeSwiftly resume
                        </button>
                        <div class="import-divider"><span>or upload a file</span></div>
                    </div>

                    <!-- File Upload -->
                    <div id="drop-zone" class="upload-zone" onclick="document.getElementById('file-input').click()"
                        ondragover="event.preventDefault();this.classList.add('dragover')"
                        ondragleave="this.classList.remove('dragover')"
                        ondrop="event.preventDefault();this.classList.remove('dragover');handleFile(event.dataTransfer.files[0])">
                        <i class="fa-solid fa-cloud-arrow-up"
                            style="font-size:2rem;color:var(--primary-color);margin-bottom:0.5rem;"></i>
                        <p style="margin:0;font-weight:500;">Drop your resume here or click to browse</p>
                        <p style="margin:0.25rem 0 0;font-size:0.8rem;color:var(--text-secondary);">PDF, DOCX, or TXT
                        </p>
                    </div>
                    <input type="file" id="file-input" accept=".pdf,.docx,.txt" style="display:none"
                        onchange="handleFile(this.files[0])">

                    <div id="file-status"
                        style="display:none;margin-top:0.75rem;font-size:0.85rem;color:var(--text-secondary);">
                        <i class="fa-solid fa-spinner fa-spin"></i> <span id="file-status-text">Parsing resume...</span>
                    </div>
                </div>

                <!-- Tab C: From Jobs -->
                <div id="tab-jobs" class="tab-content">
                    <p style="font-weight:600;font-size:0.95rem;margin-bottom:0.75rem;">Extract interests from your job
                        applications</p>

                    <div id="jobs-login-prompt" style="display:none;text-align:center;padding:1.5rem;">
                        <i class="fa-solid fa-lock"
                            style="font-size:1.5rem;color:var(--text-secondary);margin-bottom:0.5rem;display:block;"></i>
                        <p style="color:var(--text-secondary);margin-bottom:1rem;">Log in to access your TailorMeSwiftly
                            applications</p>
                        <a href="../login.html" class="btn primary-btn" style="font-size:0.9rem;"><i
                                class="fa-solid fa-right-to-bracket"></i> Log In</a>
                    </div>

                    <div id="jobs-loading" style="display:none;text-align:center;padding:1.5rem;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--primary-color);"></i>
                        <p style="color:var(--text-secondary);margin-top:0.5rem;">Loading your applications...</p>
                    </div>

                    <div id="jobs-empty" style="display:none;text-align:center;padding:1.5rem;">
                        <i class="fa-solid fa-folder-open"
                            style="font-size:1.5rem;color:var(--text-secondary);margin-bottom:0.5rem;display:block;"></i>
                        <p style="color:var(--text-secondary);margin-bottom:0.5rem;">No applications found</p>
                        <p style="color:var(--text-secondary);font-size:0.82rem;">Generate a tailored resume on <a
                                href="../app.html" style="color:var(--primary-color);">TailorMeSwiftly.com</a> first</p>
                    </div>

                    <div id="jobs-list" style="display:none;">
                        <div id="jobs-cards"
                            style="display:flex;flex-direction:column;gap:0.5rem;max-height:280px;overflow-y:auto;">
                        </div>
                        <button class="btn primary-btn" style="margin-top:1rem;width:100%;"
                            onclick="extractFromSelectedJobs()" id="extract-jobs-btn">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Extract Interests from Selected
                        </button>
                    </div>
                </div>

                <!-- Extracted Interest Tags (shared across tabs) -->
                <div id="interest-tags-section"
                    style="display:none;margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--panel-border);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <label style="font-weight:600;font-size:0.9rem;">Extracted Interests</label>
                        <span id="import-badge"
                            style="display:none;font-size:0.72rem;padding:0.2rem 0.6rem;border-radius:10px;background:rgba(59,130,246,0.1);color:var(--primary-color);"></span>
                    </div>
                    <div id="interest-tags" class="interest-tags-wrap"></div>
                    <div style="margin-top:0.5rem;">
                        <input type="text" id="add-interest-input" placeholder="Add a topic..."
                            style="padding:0.4rem 0.75rem;border-radius:8px;border:1px solid var(--panel-border);background:var(--input-bg);color:var(--text-primary);font-size:0.85rem;font-family:inherit;width:180px;"
                            onkeydown="if(event.key==='Enter'){addInterestTag(this.value);this.value='';}">
                    </div>
                </div>

                <!-- Extraction Loading -->
                <div id="extraction-loading" style="display:none;text-align:center;padding:1.5rem 0;">
                    <i class="fa-solid fa-brain"
                        style="font-size:1.5rem;color:var(--primary-color);margin-bottom:0.5rem;display:block;"></i>
                    <p style="color:var(--text-secondary);font-size:0.9rem;" id="extraction-status">Analyzing your
                        resume to identify interests...</p>
                </div>

                <div style="margin-top:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center;">
                    <button id="generate-btn" class="btn primary-btn" onclick="generateBriefing()">
                        <i class="fa-solid fa-bolt"></i> Generate Briefing
                    </button>
                    <span id="gen-count" style="font-size:0.82rem;color:var(--text-secondary);"></span>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-section" style="display:none;text-align:center;padding:3rem 0;">
                <div class="spinner"
                    style="margin:0 auto 1rem;width:48px;height:48px;border:3px solid var(--panel-border);border-top-color:var(--primary-color);border-radius:50%;animation:spin 0.8s linear infinite;">
                </div>
                <p id="loading-status" style="color:var(--text-secondary);">Fetching news articles...</p>
                <style>
                    @keyframes spin {
                        to {
                            transform: rotate(360deg);
                        }
                    }
                </style>
            </div>

            <!-- Result Section -->
            <div id="result-section" style="display:none;">
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;flex-wrap:wrap;gap:0.5rem;">
                    <h3 style="margin:0;"><i class="fa-solid fa-newspaper" style="color:var(--primary-color);"></i> What
                        You Need to Know</h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="briefing-read-time"
                            style="font-size:0.78rem;color:var(--text-secondary);padding:0.2rem 0.6rem;background:var(--panel-bg);border-radius:20px;border:1px solid var(--panel-border);"><i
                                class="fa-regular fa-clock" style="margin-right:0.3rem;"></i>—</span>
                        <button class="btn ghost-btn" style="font-size:0.82rem;"
                            onclick="document.getElementById('result-section').style.display='none';document.getElementById('input-section').style.display='block';">
                            <i class="fa-solid fa-rotate-left"></i> New
                        </button>
                    </div>
                </div>

                <div id="briefing-interests" style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1.25rem;">
                </div>

                <!-- Audio Player -->
                <div id="audio-section"
                    style="margin-bottom:1.5rem;padding:1rem;background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:12px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:0.75rem;">
                            <i class="fa-solid fa-headphones" style="font-size:1.2rem;color:var(--primary-color);"></i>
                            <div>
                                <div style="font-weight:600;font-size:0.9rem;">Listen to this briefing</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">AI-generated audio narration
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:0.5rem;align-items:center;">
                            <button class="btn primary-btn" style="font-size:0.82rem;padding:0.4rem 1rem;"
                                onclick="listenToBriefing()" id="listen-btn">
                                <i class="fa-solid fa-headphones"></i> Listen to Podcast
                            </button>
                            <button class="btn ghost-btn" style="font-size:0.78rem;padding:0.4rem 0.75rem;"
                                onclick="showPodcastFeed()" title="Add to your podcast app">
                                <i class="fa-solid fa-podcast"></i> Feed
                            </button>
                        </div>
                    </div>
                    <div id="audio-container" style="display:none;margin-top:0.75rem;">
                        <audio id="briefing-audio" controls style="width:100%;border-radius:8px;"></audio>
                    </div>
                    <div id="podcast-feed-info"
                        style="display:none;margin-top:0.75rem;padding:0.75rem;background:rgba(59,130,246,0.05);border:1px solid rgba(59,130,246,0.15);border-radius:8px;font-size:0.82rem;">
                        <div style="font-weight:600;margin-bottom:0.5rem;"><i class="fa-solid fa-rss"
                                style="color:var(--primary-color);margin-right:0.3rem;"></i> Subscribe to Your Briefing
                            Feed</div>
                        <p style="color:var(--text-secondary);margin:0 0 0.75rem;line-height:1.5;">Get new briefings
                            delivered automatically to your favorite podcast app.</p>

                        <!-- Podcast App Buttons -->
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.75rem;">
                            <button class="btn ghost-btn" onclick="subscribePodcast('apple')"
                                style="font-size:0.78rem;padding:0.45rem 0.8rem;display:flex;align-items:center;gap:0.4rem;">
                                <i class="fa-brands fa-apple" style="font-size:1rem;"></i> Apple Podcasts
                            </button>
                            <button class="btn ghost-btn" onclick="subscribePodcast('spotify')"
                                style="font-size:0.78rem;padding:0.45rem 0.8rem;display:flex;align-items:center;gap:0.4rem;">
                                <i class="fa-brands fa-spotify" style="font-size:1rem;color:#1DB954;"></i> Spotify
                            </button>
                            <button class="btn ghost-btn" onclick="subscribePodcast('pocketcasts')"
                                style="font-size:0.78rem;padding:0.45rem 0.8rem;display:flex;align-items:center;gap:0.4rem;">
                                <i class="fa-solid fa-podcast" style="font-size:0.9rem;color:#F43E37;"></i> Pocket Casts
                            </button>
                        </div>

                        <!-- RSS Feed URL -->
                        <div style="border-top:1px solid var(--panel-border);padding-top:0.6rem;">
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.4rem;">Or copy the
                                RSS feed URL:</div>
                            <div style="display:flex;gap:0.5rem;align-items:center;">
                                <input type="text" id="podcast-feed-url" readonly
                                    style="flex:1;padding:0.4rem 0.75rem;border:1px solid var(--panel-border);border-radius:6px;background:var(--input-bg);color:var(--text-primary);font-size:0.82rem;font-family:monospace;">
                                <button class="btn ghost-btn" style="font-size:0.78rem;white-space:nowrap;"
                                    onclick="copyPodcastUrl()">
                                    <i class="fa-solid fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="briefing-content" class="briefing-body"></div>

                <div id="briefing-sources"
                    style="margin-top:2rem;padding-top:1.25rem;border-top:1px solid var(--panel-border);">
                    <h4 style="font-size:0.95rem;margin-bottom:0.75rem;color:var(--text-secondary);"><i
                            class="fa-solid fa-link" style="margin-right:0.4rem;"></i> Sources</h4>
                    <div id="sources-list" class="sources-grid"></div>
                </div>
            </div>
        </main>

        <footer class="site-footer" role="contentinfo"></footer>
    </div>

    <script>
        window.TMS_PATH_PREFIX = '../';
        // Early JWT alert interceptor — must run before any library loads
        (function () { var o = window.alert; window.alert = function (m) { if (m && String(m).includes('JWT')) { console.warn('[JWT Intercept]', m); return; } return o.apply(this, arguments); }; })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="../brand-config.js"></script>
    <script src="../auth.js?v=10"></script>
    <script src="../billing.js?v=1"></script>
    <script src="../components.js"></script>
    <script>
        let extractedInterests = [];
        let currentBriefingDate = null; // tracks which briefing is displayed
        let tmsApplications = [];

        // Edge Function helper — bypasses sb_publishable_ key issue with supabaseClient.functions.invoke()
        const EDGE_FN_BASE = 'https://gwmpdgjvcjzndbloctla.supabase.co/functions/v1';

        async function getFreshToken() {
            // Try cached session first
            let { data: { session } } = await window.supabaseClient.auth.getSession();
            if (session) {
                // Check if token expires within 60s — if so, force refresh
                const exp = JSON.parse(atob(session.access_token.split('.')[1])).exp;
                if (exp * 1000 - Date.now() < 60000) {
                    const { data } = await window.supabaseClient.auth.refreshSession();
                    if (data?.session) session = data.session;
                }
            }
            return session;
        }

        async function invokeEdge(fnName, body) {
            let session = await getFreshToken();
            if (!session) {
                window.location.href = '../login.html';
                throw new Error('Not authenticated — please log in.');
            }

            let resp = await fetch(`${EDGE_FN_BASE}/${fnName}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                body: JSON.stringify(body)
            });

            // On 401, try one refresh + retry before giving up
            if (resp.status === 401) {
                const { data } = await window.supabaseClient.auth.refreshSession();
                if (data?.session) {
                    session = data.session;
                    resp = await fetch(`${EDGE_FN_BASE}/${fnName}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                        body: JSON.stringify(body)
                    });
                }
            }

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                const errMsg = data?.message || data?.error?.message || data?.error || `Edge function error (${resp.status})`;
                if (resp.status === 401 || /jwt|token|expires|unauthorized|auth/i.test(String(errMsg))) {
                    try { window.supabaseClient.auth.signOut({ scope: 'local' }); } catch (e) { }
                    window.location.href = '../login.html';
                    return new Promise(() => { }); // Halt execution while browser redirects
                }
                throw new Error(errMsg);
            }
            return data;
        }

        // PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // ── Tab Switching ──
        function switchTab(tab) {
            document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');

            if (tab === 'jobs') loadTMSApplications();
            if (tab === 'resume') checkTMSResumeAvailable();
        }

        // ── URL Params ──
        (function () {
            const params = new URLSearchParams(window.location.search);
            const urlInterests = params.get('interests');
            if (urlInterests) {
                const tags = urlInterests.split(',').map(s => s.trim()).filter(Boolean);
                if (tags.length) {
                    extractedInterests = tags;
                    renderInterestTags(tags);
                    showImportBadge('Imported from TailorMeSwiftly');
                }
            }
        })();

        // ── Load saved interests on auth ready ──
        document.addEventListener('auth-ready', async () => {
            if (extractedInterests.length) return; // URL params take priority
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) return;
                const { data: profile } = await window.supabaseClient
                    .from('user_profiles')
                    .select('interests')
                    .eq('user_id', session.user.id)
                    .maybeSingle();
                if (profile?.interests?.length) {
                    extractedInterests = profile.interests;
                    renderInterestTags(profile.interests);
                    showImportBadge('From your saved profile');
                }
            } catch (e) { /* no saved interests */ }
        });

        // ── File Upload & Parsing ──
        async function handleFile(file) {
            if (!file) return;
            const ext = file.name.split('.').pop().toLowerCase();
            const statusEl = document.getElementById('file-status');
            const statusText = document.getElementById('file-status-text');
            statusEl.style.display = 'block';
            statusText.textContent = 'Parsing ' + file.name + '...';

            try {
                let text = '';
                if (ext === 'pdf') text = await extractTextFromPDF(file);
                else if (ext === 'docx') text = await extractTextFromDOCX(file);
                else if (ext === 'txt') text = await file.text();
                else throw new Error('Unsupported file type');

                if (!text.trim()) throw new Error('No text found in file');

                statusText.textContent = file.name + ' parsed successfully';
                statusEl.querySelector('i').className = 'fa-solid fa-check';
                statusEl.querySelector('i').style.color = 'var(--primary-color)';

                await extractInterestsFromText(text, 'resume');
            } catch (e) {
                statusText.textContent = e.message || 'Failed to parse file';
                statusEl.querySelector('i').className = 'fa-solid fa-xmark';
                statusEl.querySelector('i').style.color = '#ef4444';
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        // ── TMS Resume Import ──
        async function checkTMSResumeAvailable() {
            const section = document.getElementById('tms-resume-section');
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { section.style.display = 'none'; return; }

                const { data } = await window.supabaseClient
                    .from('generations')
                    .select('id')
                    .eq('user_id', session.user.id)
                    .not('resume_text', 'is', null)
                    .limit(1);

                section.style.display = (data?.length) ? 'block' : 'none';
            } catch (e) { section.style.display = 'none'; }
        }

        async function fetchTMSResume() {
            const btn = document.getElementById('import-resume-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Importing...';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) throw new Error('Not logged in');

                const { data } = await window.supabaseClient
                    .from('generations')
                    .select('resume_text')
                    .eq('user_id', session.user.id)
                    .not('resume_text', 'is', null)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();

                if (!data?.resume_text) throw new Error('No resume found in your TailorMeSwiftly account. Create an application first.');

                await extractInterestsFromText(data.resume_text, 'resume');
                showImportBadge('From TailorMeSwiftly resume');
            } catch (e) {
                const msg = e.message || '';
                if (msg.includes('JWT') || msg.includes('token') || msg.includes('Auth')) {
                    alert('Session expired or corrupted. Please log in again.');
                    if (window.supabaseClient) window.supabaseClient.auth.signOut({ scope: 'local' }).catch(() => { });
                    window.location.href = '../login.html';
                    return;
                }
                alert(msg || 'Failed to import resume');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-link"></i> Use my TailorMeSwiftly resume';
        }

        // ── TMS Job Applications Import ──
        async function loadTMSApplications() {
            const loginEl = document.getElementById('jobs-login-prompt');
            const loadingEl = document.getElementById('jobs-loading');
            const emptyEl = document.getElementById('jobs-empty');
            const listEl = document.getElementById('jobs-list');

            loginEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.style.display = 'none';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { loginEl.style.display = 'block'; return; }

                if (tmsApplications.length) { renderJobCards(); return; }

                loadingEl.style.display = 'block';

                const { data } = await window.supabaseClient
                    .from('generations')
                    .select('id, job_text, job_description, target_company, created_at')
                    .eq('user_id', session.user.id)
                    .not('job_text', 'is', null)
                    .order('created_at', { ascending: false })
                    .limit(20);

                loadingEl.style.display = 'none';

                if (!data?.length) { emptyEl.style.display = 'block'; return; }

                tmsApplications = data;
                renderJobCards();
            } catch (e) {
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }

        function renderJobCards() {
            const container = document.getElementById('jobs-cards');
            container.innerHTML = tmsApplications.map((app, i) => {
                const company = app.target_company || 'Unknown Company';
                const date = new Date(app.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const preview = (app.job_text || '').substring(0, 80).replace(/<[^>]+>/g, '') + '...';
                return `<label class="job-card">
                    <input type="checkbox" value="${i}" class="job-checkbox">
                    <div class="job-card-content">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong style="font-size:0.9rem;">${company}</strong>
                            <span style="font-size:0.75rem;color:var(--text-secondary);">${date}</span>
                        </div>
                        <p style="font-size:0.8rem;color:var(--text-secondary);margin:0.25rem 0 0;line-height:1.4;">${preview}</p>
                    </div>
                </label>`;
            }).join('');
            document.getElementById('jobs-list').style.display = 'block';
        }

        async function extractFromSelectedJobs() {
            const checked = [...document.querySelectorAll('.job-checkbox:checked')].map(c => parseInt(c.value));
            if (!checked.length) { alert('Select at least one application'); return; }

            const btn = document.getElementById('extract-jobs-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Extracting...';

            const combinedText = checked.map(i => {
                const app = tmsApplications[i];
                return `Company: ${app.target_company || 'Unknown'}\nJob Description: ${app.job_text || app.job_description || ''}`;
            }).join('\n\n---\n\n');

            await extractInterestsFromText(combinedText, 'job applications');
            showImportBadge('From ' + checked.length + ' TailorMeSwiftly application' + (checked.length > 1 ? 's' : ''));

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Extract Interests from Selected';
        }

        // ── AI Interest Extraction ──
        async function extractInterestsFromText(text, sourceType) {
            const loadingEl = document.getElementById('extraction-loading');
            const statusEl = document.getElementById('extraction-status');
            loadingEl.style.display = 'block';
            statusEl.textContent = `Analyzing your ${sourceType} to identify interests...`;

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { window.location.href = '../login.html'; return; }

                const systemPrompt = `You are an interest extraction engine. Given a ${sourceType}, extract 5-10 news topics the person would likely want to follow.

RULES:
- Return ONLY a valid JSON array of short topic strings
- Focus on: industry sectors, technologies, skills, companies, market trends
- Be specific enough to find relevant news (e.g. "cloud computing" not just "technology")
- Avoid generic terms like "work" or "career"
- No explanation, just the JSON array

Example output: ["AI/ML", "cloud computing", "fintech", "React", "startup funding"]`;

                const data = await invokeEdge('gemini-proxy', {
                    contents: [{ parts: [{ text: text.substring(0, 8000) }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.3, maxOutputTokens: 512 }
                });
                if (data?.error) throw new Error(data.error.message || 'AI extraction failed');
                // Gemini 2.5 may return thinking parts — find the non-thinking part
                const extractParts = data.candidates?.[0]?.content?.parts || [];
                const extractPart = extractParts.find(p => !p.thought) || extractParts[extractParts.length - 1];
                const raw = extractPart?.text || '[]';
                // Parse JSON from response (handle markdown code blocks)
                const jsonStr = raw.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
                const interests = JSON.parse(jsonStr);

                if (!Array.isArray(interests) || !interests.length) throw new Error('No interests extracted');

                extractedInterests = interests.map(s => String(s).trim()).filter(Boolean);
                renderInterestTags(extractedInterests);
                saveInterestsToProfile(extractedInterests);

            } catch (e) {
                console.error('Extraction error:', e);
                const msg = e.message || '';
                if (msg.includes('Auth') || msg.includes('token') || msg.includes('JWT')) {
                    alert('Session expired or corrupted. Please log in again.');
                    if (window.supabaseClient) window.supabaseClient.auth.signOut({ scope: 'local' }).catch(() => { });
                    window.location.href = '../login.html';
                    return;
                } else {
                    alert('Could not extract interests: ' + (msg || 'Unknown error') + '. Try typing them manually.');
                }
            }

            loadingEl.style.display = 'none';
        }

        // ── Interest Tags UI ──
        function renderInterestTags(interests) {
            const section = document.getElementById('interest-tags-section');
            const container = document.getElementById('interest-tags');
            section.style.display = 'block';
            container.innerHTML = interests.map((tag, i) =>
                `<span class="interest-tag editable">${tag} <button onclick="removeInterestTag(${i})" aria-label="Remove ${tag}">&times;</button></span>`
            ).join('');

            // Also sync to textarea for the generate function
            document.getElementById('interests-input').value = interests.join(', ');
        }

        function removeInterestTag(index) {
            extractedInterests.splice(index, 1);
            renderInterestTags(extractedInterests);
            if (!extractedInterests.length) {
                document.getElementById('interest-tags-section').style.display = 'none';
            }
        }

        function addInterestTag(val) {
            val = val.trim();
            if (!val || extractedInterests.includes(val)) return;
            extractedInterests.push(val);
            renderInterestTags(extractedInterests);
        }

        function showImportBadge(text) {
            const badge = document.getElementById('import-badge');
            badge.textContent = text;
            badge.style.display = 'inline-block';
        }

        // ── Save/Load Interests ──
        async function saveInterestsToProfile(interests) {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) return;
                await window.supabaseClient.from('user_profiles')
                    .update({ interests })
                    .eq('user_id', session.user.id);
            } catch (e) { /* silent */ }
        }

        // ── Generate Briefing ──
        async function generateBriefing() {
            // Use extracted tags if available, else parse textarea
            let interests = extractedInterests.length
                ? [...extractedInterests]
                : document.getElementById('interests-input').value.trim().split(',').map(s => s.trim()).filter(Boolean);

            if (!interests.length) { alert('Please enter or extract some interests first.'); return; }

            document.getElementById('input-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) { window.location.href = '../login.html'; return; }

                // Step 1: Fetch news
                document.getElementById('loading-status').textContent = 'Fetching news articles...';
                const newsData = await invokeEdge('fetch-news', { interests, max: 10 });

                if (!newsData?.articles?.length) {
                    throw new Error('No articles found for those topics. Try broader interests.');
                }

                const articles = newsData.articles;

                // Step 2: Generate briefing via Gemini
                document.getElementById('loading-status').textContent = 'Generating your personalized briefing...';

                const systemPrompt = `You are a senior intelligence analyst writing a personalized daily briefing memo for ONE specific reader. This is not a news roundup — it is a single cohesive narrative that synthesizes all the articles into ONE story about what is happening in the reader's world today and what they need to know.

VOICE & TONE:
- Write directly to the reader using "you" and "your"
- Authoritative but conversational, like a trusted advisor
- Every sentence should feel personally relevant to someone in their field
- No filler — every word must earn its place

STRUCTURE:
1. Open with a bold 1-2 sentence thesis: what is the ONE big narrative connecting today's news
2. Build the narrative in 3-5 flowing paragraphs that weave the articles together thematically
3. Each paragraph should connect multiple sources, showing how trends reinforce each other
4. Naturally cite sources inline as you reference them
5. Close with "What This Means For You" — 2-3 direct, actionable takeaways

FORMAT — use this EXACT HTML structure:
- Opening thesis: <p class="briefing-thesis"><strong>THE HEADLINE:</strong> Your 1-2 sentence thesis here.</p>
- Body paragraphs: <p>Flowing narrative text with inline citations like <a href="ARTICLE_URL" target="_blank" rel="noopener" class="briefing-cite">[Source Name]</a>.</p>
- Closing section: <h3>What This Means For You</h3> then <ul><li>Direct actionable takeaway written in second person</li></ul>
- Use the exact article URL provided for each source link
- No <html>, <body>, or <head> tags
- Do NOT use section headers to separate articles — weave them into one narrative`;

                const articleSummaries = articles.map(a =>
                    `Title: ${a.title}\nSource: ${a.source}\nDate: ${a.publishedAt}\nDescription: ${a.description}\nURL: ${a.url}`
                ).join('\n\n---\n\n');

                const userPrompt = `Create a personalized news briefing for someone interested in: ${interests.join(', ')}\n\nHere are today's relevant articles:\n\n${articleSummaries}`;

                const geminiData = await invokeEdge('gemini-proxy', {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
                });
                if (geminiData?.error) throw new Error(geminiData.error.message || 'AI generation failed');
                // Gemini 2.5 may return thinking parts — find the non-thinking part
                const geminiParts = geminiData.candidates?.[0]?.content?.parts || [];
                const briefingPart = geminiParts.find(p => !p.thought) || geminiParts[geminiParts.length - 1];
                const briefingHtml = briefingPart?.text || 'No briefing generated.';

                // Step 3: Save to DB
                await window.supabaseClient.from('daily_briefings').upsert({
                    user_id: session.user.id,
                    briefing_date: new Date().toISOString().split('T')[0],
                    interests: interests,
                    briefing_html: briefingHtml,
                    briefing_text: briefingHtml.replace(/<[^>]+>/g, ''),
                    sources: articles.map(a => ({ title: a.title, url: a.url, source: a.source, publishedAt: a.publishedAt })),
                    metadata: { model: 'gemini-3-flash-preview', generated_at: new Date().toISOString() }
                }, { onConflict: 'user_id,briefing_date' });

                currentBriefingDate = new Date().toISOString().split('T')[0];

                // Save interests to profile for next time
                saveInterestsToProfile(interests);

                // Step 4: Display result
                showBriefing(briefingHtml, interests, articles);

            } catch (e) {
                console.error('Briefing error:', e);
                const msg = e.message || '';
                if (/jwt|token|expires|unauthorized|auth/i.test(msg)) {
                    if (window.supabaseClient) window.supabaseClient.auth.signOut({ scope: 'local' }).catch(() => { });
                    window.location.href = '../login.html';
                    return;
                }

                document.getElementById('loading-section').style.display = 'none';
                document.getElementById('input-section').style.display = 'block';

                // Display error inline instead of an alert
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-text';
                errorDiv.style.marginTop = '1rem';
                errorDiv.style.textAlign = 'center';
                errorDiv.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${msg || 'Failed to generate briefing. Please try again.'}`;

                const existingErr = document.querySelector('#input-section .error-text');
                if (existingErr) existingErr.remove();
                document.getElementById('input-section').appendChild(errorDiv);
            }
        }

        function showBriefing(html, interests, articles) {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';

            const tagsEl = document.getElementById('briefing-interests');
            tagsEl.innerHTML = interests.map(i => `<span class="interest-tag">${i}</span>`).join('');

            // Calculate estimated read time
            const plainText = html.replace(/<[^>]+>/g, '');
            const wordCount = plainText.trim().split(/\s+/).length;
            const readMin = Math.max(1, Math.round(wordCount / 200));
            document.getElementById('briefing-read-time').textContent = `${readMin} min read`;

            // Post-process: convert plain [Source: name] text into clickable links
            let processedHtml = html;
            if (articles && articles.length) {
                // Build a lookup map from source name to URL
                const sourceMap = {};
                articles.forEach(a => {
                    if (a.source) sourceMap[a.source.toLowerCase()] = a.url;
                    if (a.title) sourceMap[a.title.toLowerCase()] = a.url;
                });
                // Replace [Source: name] with clickable links
                processedHtml = processedHtml.replace(/\[Source:\s*([^\]]+)\]/gi, (match, name) => {
                    const key = name.trim().toLowerCase();
                    const url = sourceMap[key];
                    if (url) return `<a href="${url}" target="_blank" rel="noopener" class="briefing-cite">[${name.trim()}]</a>`;
                    return `<span class="briefing-cite">[${name.trim()}]</span>`;
                });
            }
            document.getElementById('briefing-content').innerHTML = processedHtml;

            const srcEl = document.getElementById('sources-list');
            srcEl.innerHTML = articles.map(a => {
                const url = a.url || '#';
                const name = a.source || a.title || 'Source';
                const title = a.title || '';
                return `<a href="${url}" target="_blank" rel="noopener" class="briefing-source-card">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    <div>
                        <div class="source-name">${name}</div>
                        ${title ? `<div class="source-title">${title}</div>` : ''}
                    </div>
                </a>`;
            }).join('');
        }

        // ── View Mode: load a saved briefing from feed ──
        (async function checkViewMode() {
            const params = new URLSearchParams(window.location.search);
            const viewId = params.get('view');
            if (!viewId) return;

            // Try sessionStorage first (set by feed.html)
            let briefing = null;
            try {
                const cached = sessionStorage.getItem('ttn_view_briefing');
                if (cached) briefing = JSON.parse(cached);
            } catch (e) { }

            // If not cached or wrong ID, fetch from DB
            if (!briefing || briefing.id !== viewId) {
                // Wait for supabase
                if (!window.supabaseClient) {
                    await new Promise(r => {
                        let tries = 0;
                        const poll = setInterval(() => {
                            if (window.supabaseClient || ++tries > 80) { clearInterval(poll); r(); }
                        }, 100);
                    });
                }
                if (!window.supabaseClient) return;
                const { data } = await window.supabaseClient.from('daily_briefings').select('*').eq('id', viewId).single();
                if (data) briefing = data;
            }

            if (!briefing) return;

            currentBriefingDate = briefing.briefing_date;

            // Display the saved briefing
            const interests = briefing.interests || [];
            const sources = briefing.sources || [];
            const html = briefing.briefing_html || briefing.briefing_text || '';

            document.getElementById('input-section').style.display = 'none';
            showBriefing(html, interests, sources);
        })();

        function getPodcastFeedUrl() {
            return window.location.origin + '/news/feed.xml';
        }

        function showPodcastFeed() {
            const info = document.getElementById('podcast-feed-info');
            if (info.style.display !== 'none' && info.style.display !== '') {
                info.style.display = 'none';
                return;
            }
            document.getElementById('podcast-feed-url').value = getPodcastFeedUrl();
            info.style.display = 'block';
        }

        function subscribePodcast(app) {
            const feedUrl = getPodcastFeedUrl();
            const instructions = {
                apple: { name: 'Apple Podcasts', steps: '1. Open Apple Podcasts\n2. Go to Library → Shows\n3. Tap the + icon → "Follow a Show by URL"\n4. Paste the feed URL' },
                spotify: { name: 'Spotify', steps: '1. Open Spotify\n2. Go to Your Library\n3. Tap the + button → "Add a Podcast by URL"\n4. Paste the feed URL' },
                pocketcasts: { name: 'Pocket Casts', steps: '1. Open Pocket Casts\n2. Tap Discover → search icon\n3. Tap "Add by URL" at the bottom\n4. Paste the feed URL' }
            };
            const info = instructions[app];
            navigator.clipboard.writeText(feedUrl).then(() => {
                alert('Feed URL copied!\n\nTo add in ' + info.name + ':\n' + info.steps);
            }).catch(() => {
                prompt('Copy this feed URL and add it in ' + info.name + ':\n\n' + info.steps, feedUrl);
            });
        }

        function copyPodcastUrl() {
            const input = document.getElementById('podcast-feed-url');
            navigator.clipboard.writeText(input.value).then(() => {
                const btn = input.nextElementSibling;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy'; }, 2000);
            });
        }

        function extractBriefingText() {
            const content = document.getElementById('briefing-content');
            if (!content || !content.textContent.trim()) return '';
            return content.textContent.replace(/\[.*?\]/g, '').trim();
        }

        // ── Podcast Audio Playback ──
        function playAudioUrl(url) {
            const audioContainer = document.getElementById('audio-container');
            const audioEl = document.getElementById('briefing-audio');
            audioEl.src = url;
            audioContainer.style.display = 'block';
            audioEl.play().catch(() => { /* autoplay blocked, user can click play */ });

            const btn = document.getElementById('listen-btn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-headphones"></i> Listen to Podcast';
        }

        function stopPodcast() {
            const audioEl = document.getElementById('briefing-audio');
            if (audioEl) { audioEl.pause(); audioEl.currentTime = 0; }
            const btn = document.getElementById('listen-btn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-headphones"></i> Listen to Podcast';
        }

        async function listenToBriefing() {
            const btn = document.getElementById('listen-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (!session) throw new Error('Please sign in to use audio playback.');

                // Check for cached audio URL (up to 7 days old)
                if (currentBriefingDate) {
                    const { data: row } = await window.supabaseClient
                        .from('daily_briefings')
                        .select('audio_url, created_at')
                        .eq('user_id', session.user.id)
                        .eq('briefing_date', currentBriefingDate)
                        .single();

                    if (row?.audio_url && row.audio_url.startsWith('http')) {
                        playAudioUrl(row.audio_url);
                        return;
                    }
                }

                // Generate podcast via Podcastfy (Gemini + ElevenLabs TTS)
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating podcast<span id="podcast-dots">.</span>';
                // Animate dots while waiting
                const dotsInterval = setInterval(() => {
                    const dots = document.getElementById('podcast-dots');
                    if (dots) dots.textContent = dots.textContent.length >= 3 ? '.' : dots.textContent + '.';
                }, 800);

                const briefingText = extractBriefingText();
                if (!briefingText || briefingText.length < 50) throw new Error('No briefing content to convert.');

                const result = await invokeEdge('elevenlabs-tts', { text: briefingText.substring(0, 8000) });
                clearInterval(dotsInterval);

                if (result?.error) throw new Error(result.error);
                if (!result?.audioUrl) throw new Error('No audio generated. Please try again.');

                // Cache the audio URL
                if (currentBriefingDate) {
                    try {
                        await window.supabaseClient
                            .from('daily_briefings')
                            .update({ audio_url: result.audioUrl })
                            .eq('user_id', session.user.id)
                            .eq('briefing_date', currentBriefingDate);
                    } catch (cacheErr) {
                        console.warn('Failed to cache podcast URL:', cacheErr);
                    }
                }

                playAudioUrl(result.audioUrl);
            } catch (e) {
                console.error('Podcast error:', e);
                const msg = e.message || '';
                if (/jwt|token|expires|unauthorized|auth/i.test(msg)) {
                    if (window.supabaseClient) window.supabaseClient.auth.signOut({ scope: 'local' }).catch(() => { });
                    window.location.href = '../login.html';
                    return;
                }
                alert(msg || 'Podcast generation failed. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-headphones"></i> Listen to Podcast';
            }
        }
    </script>
</body>

</html>