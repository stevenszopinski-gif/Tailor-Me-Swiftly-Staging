<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI analyzes your interview delivery â€” filler words, speaking pace, and presentation skills â€” to give you a confidence score.">
    <link rel="alternate" type="application/rss+xml" title="TailorMeSwiftly.com Release Notes" href="/feed.xml">
    <title>Confidence Scorer â€“ TailorMeSwiftly</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=6">
    <link rel="stylesheet" href="templates.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7832382680038641" crossorigin="anonymous"></script>
    <style>
        .result-page { max-width: 800px; margin: 0 auto; padding: 1.5rem 1.5rem 4rem; }
        .recorder-wrap { position: relative; width: 100%; max-width: 480px; margin: 0 auto; border-radius: 16px; overflow: hidden; background: #000; }
        .recorder-wrap video { width: 100%; display: block; transform: scaleX(-1); }
        .question-overlay { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(rgba(0,0,0,0.8), transparent); padding: 1.25rem; color: #fff; font-size: 0.9rem; line-height: 1.5; text-align: center; font-weight: 500; }
        .record-controls { display: flex; gap: 0.75rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap; }
        .filler-counter { display: flex; gap: 1.5rem; justify-content: center; margin: 1rem 0; flex-wrap: wrap; }
        .filler-stat { text-align: center; }
        .filler-stat .count { font-size: 2rem; font-weight: 800; font-family: 'Outfit', sans-serif; }
        .filler-stat .label { font-size: 0.75rem; color: var(--text-secondary); }
        .score-card { background: var(--glass-bg); border: 1px solid var(--panel-border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.25rem; }
        .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .metric-row:last-child { border-bottom: none; }
        .pace-indicator { font-size: 0.85rem; font-weight: 600; }
    </style>
</head>

<body>
    <div class="app-container" style="min-height: auto;">
        <header class="app-header">
            <div class="logo">
                <a href="index.html" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:0.75rem;">
                    <div class="logo-icon"><i class="fa-solid fa-clipboard"></i></div>
                    <h1>TailorMeSwiftly.com</h1>
                </a>
            </div>
            <div class="header-actions" style="display:flex;gap:1rem;align-items:center;">
                <div id="user-profile" style="display:none;flex-direction:column;align-items:center;gap:0.2rem;position:relative;">
                    <img id="user-avatar" src="" alt="Avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);cursor:pointer;" onclick="document.getElementById('avatar-dropdown').classList.toggle('hidden')">
                    <span id="user-greeting" style="font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;"></span>
                    <div id="avatar-dropdown" class="avatar-dropdown hidden">
                        <button class="dropdown-item" id="open-prefs" onclick="location.href='app.html'"><i class="fa-solid fa-sliders"></i> Preferences</button>
                        <a href="updates.html" class="dropdown-item" style="text-decoration:none;color:inherit;"><i class="fa-solid fa-bullhorn"></i> Release Notes</a>
                        <a href="history.html" class="dropdown-item" style="text-decoration:none;color:inherit;"><i class="fa-solid fa-table-columns"></i> Application Tracker</a>
                        <button class="dropdown-item theme-btn" id="theme-toggle"><i class="fa-solid fa-moon"></i> Theme</button>
                        <div style="height:1px;background:var(--panel-border);margin:0.3rem 0;"></div>
                        <button class="dropdown-item" id="logout-btn"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out</button>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <div class="result-page">
        <div style="text-align:center;margin-bottom:1.5rem;">
            <a href="results.html" style="color:var(--text-secondary);text-decoration:none;font-size:0.85rem;"><i class="fa-solid fa-arrow-left"></i> Back to Results</a>
        </div>
        <h1 style="text-align:center;font-size:1.6rem;margin:0 0 0.5rem;"><i class="fa-solid fa-microphone-lines" style="color:#ec4899;margin-right:0.5rem;"></i>Interview Confidence Scorer</h1>
        <p style="text-align:center;color:var(--text-secondary);margin-bottom:2rem;">Record yourself answering a question. AI grades your delivery, not just your words.</p>

        <div id="practice-area">
            <div style="text-align:center;margin-bottom:1.5rem;">
                <button class="btn primary-btn" onclick="startPractice()"><i class="fa-solid fa-play"></i> Start Practice Session</button>
            </div>
        </div>

        <div id="recording-area" style="display:none;">
            <div class="recorder-wrap">
                <video id="webcam" autoplay muted playsinline></video>
                <div class="question-overlay" id="question-text">Loading question...</div>
            </div>
            <div style="text-align:center;margin-top:0.75rem;">
                <span id="rec-timer" style="font-size:1.3rem;font-weight:700;font-family:'Outfit',monospace;">0:00</span>
            </div>
            <div class="record-controls">
                <button class="btn primary-btn" id="rec-btn" onclick="toggleRecording()"><i class="fa-solid fa-circle" style="color:#ef4444;"></i> Start Recording</button>
                <button class="btn ghost-btn" onclick="nextQuestion()"><i class="fa-solid fa-forward"></i> Next Question</button>
            </div>
        </div>

        <div id="analysis-output"></div>

        <div style="background:rgba(236,72,153,0.06);border:1px solid rgba(236,72,153,0.2);border-radius:12px;padding:1.25rem;margin-top:1.5rem;">
            <h3 style="margin:0 0 0.75rem;font-size:0.95rem;"><i class="fa-solid fa-lightbulb" style="color:#ec4899;margin-right:0.4rem;"></i> What Gets Analyzed</h3>
            <ul style="margin:0;padding-left:1.2rem;font-size:0.85rem;line-height:1.7;color:var(--text-secondary);">
                <li><strong>Filler words</strong> â€” "um," "like," "you know," "basically"</li>
                <li><strong>Speaking pace</strong> â€” too fast, too slow, or just right</li>
                <li><strong>Answer structure</strong> â€” clear STAR format vs. rambling</li>
                <li><strong>Confidence markers</strong> â€” hedging language, apologetic tone</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="auth.js?v=8"></script>
    <script src="error-utils.js"></script>
    <script src="results.js?v=6"></script>
    <script>
        initResultTheme();
        initResultAuth();
        const outputs = loadOutputs();
        if (!outputs) showSessionExpired(document.querySelector('.result-page'));

        let mediaRecorder = null;
        let recordedChunks = [];
        let recognition = null;
        let transcript = '';
        let timerInterval = null;
        let seconds = 0;
        let currentQuestionIdx = 0;
        let questions = [];
        let isRecording = false;

        const fillerWords = ['um', 'uh', 'like', 'you know', 'basically', 'actually', 'literally', 'right', 'so yeah', 'i mean'];
        let fillerCount = 0;
        let wordCount = 0;

        async function startPractice() {
            document.getElementById('practice-area').style.display = 'none';
            document.getElementById('recording-area').style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('webcam').srcObject = stream;
            } catch (e) {
                alert('Please allow camera and microphone access.');
                return;
            }

            // Generate questions
            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: 'Generate 5 interview questions for this role. Return EXACTLY a JSON array of strings (no markdown, no code fences). Example: ["Question 1?", "Question 2?"]' }] },
                        contents: [{ parts: [{ text: `Job: ${outputs?.jobText?.substring(0, 500) || 'Software engineering role'}\nCompany: ${outputs?.targetCompany || 'Unknown'}` }] }],
                        generationConfig: { temperature: 0.7 }
                    }
                });
                if (error) throw new Error(error.message);
                let text = data.candidates[0].content.parts[0].text.trim();
                if (text.startsWith('```')) text = text.replace(/^```\w*\n?/, '').replace(/```$/, '').trim();
                questions = JSON.parse(text);
            } catch (e) {
                questions = ['Tell me about yourself.', 'Why do you want this role?', 'What is your greatest strength?', 'Describe a challenge you overcame.', 'Where do you see yourself in 5 years?'];
            }

            document.getElementById('question-text').textContent = questions[0];
        }

        function nextQuestion() {
            currentQuestionIdx = (currentQuestionIdx + 1) % questions.length;
            document.getElementById('question-text').textContent = questions[currentQuestionIdx];
        }

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            const video = document.getElementById('webcam');
            if (!video.srcObject) return;

            isRecording = true;
            transcript = '';
            fillerCount = 0;
            wordCount = 0;
            seconds = 0;

            const btn = document.getElementById('rec-btn');
            btn.innerHTML = '<i class="fa-solid fa-stop" style="color:#ef4444;"></i> Stop';

            // Start timer
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById('rec-timer').textContent = `${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}`;
            }, 1000);

            // Start speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.onresult = (event) => {
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            const text = event.results[i][0].transcript.toLowerCase();
                            transcript += text + ' ';
                            wordCount += text.split(/\s+/).filter(w => w).length;
                            fillerWords.forEach(fw => {
                                const regex = new RegExp('\\b' + fw + '\\b', 'gi');
                                const matches = text.match(regex);
                                if (matches) fillerCount += matches.length;
                            });
                        }
                    }
                };
                recognition.start();
            }
        }

        function stopRecording() {
            isRecording = false;
            clearInterval(timerInterval);
            if (recognition) recognition.stop();

            const btn = document.getElementById('rec-btn');
            btn.innerHTML = '<i class="fa-solid fa-circle" style="color:#ef4444;"></i> Start Recording';

            analyzeDelivery();
        }

        async function analyzeDelivery() {
            const container = document.getElementById('analysis-output');
            container.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:2rem;"><i class="fa-solid fa-spinner fa-spin"></i> Analyzing your delivery...</p>';

            const wpm = seconds > 0 ? Math.round((wordCount / seconds) * 60) : 0;
            const fillerRate = wordCount > 0 ? ((fillerCount / wordCount) * 100).toFixed(1) : 0;

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: `You are an interview presentation coach. Analyze the candidate's speech delivery metrics and transcript. Give specific, actionable feedback.

Return EXACTLY this JSON (no markdown, no code fences):
{
    "confidenceScore": number (0-100),
    "grade": "A+"|"A"|"B+"|"B"|"C+"|"C"|"D"|"F",
    "paceAssessment": "Too fast"|"Slightly fast"|"Perfect pace"|"Slightly slow"|"Too slow",
    "structureScore": number (0-10),
    "clarityScore": number (0-10),
    "fillerAssessment": "Excellent"|"Good"|"Needs work"|"Major issue",
    "strengths": ["2-3 specific things they did well"],
    "improvements": ["2-3 specific things to improve"],
    "coachTip": "1 high-impact tip for immediate improvement"
}` }] },
                        contents: [{ parts: [{ text: `Question: "${questions[currentQuestionIdx]}"\n\nTranscript: "${transcript || 'No speech detected'}"\n\nMetrics:\n- Duration: ${seconds}s\n- Words: ${wordCount}\n- WPM: ${wpm}\n- Filler words: ${fillerCount}\n- Filler rate: ${fillerRate}%` }] }],
                        generationConfig: { temperature: 0.5 }
                    }
                });

                if (error) throw new Error(error.message);
                let text = data.candidates[0].content.parts[0].text.trim();
                if (text.startsWith('```')) text = text.replace(/^```\w*\n?/, '').replace(/```$/, '').trim();
                const result = JSON.parse(text);
                renderAnalysis(result, wpm, fillerRate);
            } catch (e) {
                container.innerHTML = `<p style="color:var(--error-color);text-align:center;">Analysis failed: ${e.message}</p>`;
            }
        }

        function renderAnalysis(result, wpm, fillerRate) {
            const container = document.getElementById('analysis-output');
            const score = result.confidenceScore;
            const color = score >= 75 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';

            let html = `<div class="score-card" style="text-align:center;">
                <div style="font-size:3rem;font-weight:800;color:${color};">${score}</div>
                <div style="font-size:1.2rem;font-weight:700;color:${color};">${result.grade}</div>
                <p style="font-size:0.85rem;color:var(--text-secondary);margin:0.5rem 0 0;">Confidence Score</p>
            </div>`;

            html += `<div class="filler-counter">
                <div class="filler-stat"><div class="count" style="color:var(--text-primary);">${wpm}</div><div class="label">Words/Min</div></div>
                <div class="filler-stat"><div class="count" style="color:${fillerCount > 5 ? '#ef4444' : '#10b981'};">${fillerCount}</div><div class="label">Filler Words</div></div>
                <div class="filler-stat"><div class="count" style="color:${parseFloat(fillerRate) > 3 ? '#ef4444' : '#10b981'};">${fillerRate}%</div><div class="label">Filler Rate</div></div>
                <div class="filler-stat"><div class="count" style="color:var(--text-primary);">${seconds}s</div><div class="label">Duration</div></div>
            </div>`;

            html += `<div class="score-card"><h3 style="margin:0 0 1rem;font-size:1rem;">Detailed Metrics</h3>`;
            const metrics = [
                { name: 'Speaking Pace', value: result.paceAssessment },
                { name: 'Answer Structure', value: `${result.structureScore}/10` },
                { name: 'Clarity', value: `${result.clarityScore}/10` },
                { name: 'Filler Words', value: result.fillerAssessment }
            ];
            metrics.forEach(m => {
                html += `<div class="metric-row"><span style="font-weight:600;font-size:0.9rem;">${m.name}</span><span class="pace-indicator">${m.value}</span></div>`;
            });
            html += `</div>`;

            html += `<div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
                <div class="score-card" style="flex:1;min-width:250px;"><h4 style="margin:0 0 0.5rem;color:#10b981;font-size:0.9rem;"><i class="fa-solid fa-check-circle"></i> Strengths</h4><ul style="margin:0;padding-left:1rem;font-size:0.85rem;line-height:1.7;color:var(--text-secondary);">`;
            result.strengths.forEach(s => { html += `<li>${s}</li>`; });
            html += `</ul></div><div class="score-card" style="flex:1;min-width:250px;"><h4 style="margin:0 0 0.5rem;color:#f59e0b;font-size:0.9rem;"><i class="fa-solid fa-arrow-up"></i> Improvements</h4><ul style="margin:0;padding-left:1rem;font-size:0.85rem;line-height:1.7;color:var(--text-secondary);">`;
            result.improvements.forEach(s => { html += `<li>${s}</li>`; });
            html += `</ul></div></div>`;

            html += `<div style="background:rgba(236,72,153,0.06);border:1px solid rgba(236,72,153,0.2);border-radius:12px;padding:1rem;text-align:center;">
                <p style="font-size:0.9rem;margin:0;"><i class="fa-solid fa-lightbulb" style="color:#ec4899;margin-right:0.3rem;"></i> <strong>Coach's Tip:</strong> ${result.coachTip}</p>
            </div>`;

            container.innerHTML = html;
        }
    </script>

    <footer class="site-footer">
        <p>&copy; 2026 TailorMeSwiftly.com. This service is free to use and supported by advertising.</p>
        <p><a href="terms.html">Terms & Conditions</a> | <a href="privacy.html">Privacy Policy</a></p>
    </footer>
</body>

</html>
