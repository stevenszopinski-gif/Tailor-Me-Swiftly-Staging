<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Prep â€“ TailorMeSwiftly</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=5">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7832382680038641"
        crossorigin="anonymous"></script>
    <style>
        .result-page {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem 1.5rem 4rem;
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-back {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .result-back:hover {
            color: var(--text-primary);
        }

        .result-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        /* Progress dots */
        .mock-progress {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--panel-border);
            transition: all 0.3s;
        }

        .progress-dot.active {
            background: var(--primary-color);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
            transform: scale(1.2);
        }

        .progress-dot.done {
            background: var(--accent-color);
        }

        /* Question card */
        .mock-question-card {
            background: var(--glass-bg);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .q-number {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .q-text-display {
            font-size: 1.2rem;
            font-weight: 600;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            min-height: 60px;
        }

        .q-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .q-actions .btn {
            font-size: 0.88rem;
        }

        /* Answer reveal */
        .answer-reveal {
            background: var(--glass-bg);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .answer-reveal.visible {
            display: block;
            animation: modalFade 0.3s ease-out;
        }

        .answer-reveal h4 {
            margin: 0 0 0.75rem;
            color: var(--accent-color);
            font-size: 0.95rem;
        }

        .answer-reveal p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
            margin: 0;
        }

        /* Practice section */
        .practice-section {
            background: rgba(0, 0, 0, 0.15);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .practice-section h4 {
            margin: 0 0 1rem;
            font-size: 0.95rem;
        }

        /* Navigation */
        .mock-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        /* TTS pulsing */
        @keyframes speakerPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .speaking .fa-volume-high {
            animation: speakerPulse 0.8s ease-in-out infinite;
            color: var(--accent-color);
        }

        @keyframes pulseRed {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>

<body>
    <nav class="top-nav">
        <div class="nav-brand"><a href="index.html" style="text-decoration:none;color:inherit;"><i
                    class="fa-solid fa-clipboard"></i> TailorMeSwiftly</a></div>
        <div class="nav-actions">
            <div id="user-profile" style="display:none;flex-direction:column;align-items:center;gap:0.2rem;position:relative;">
                <img id="user-avatar" src="" alt="Avatar"
                    style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);cursor:pointer;"
                    onclick="document.getElementById('avatar-dropdown').classList.toggle('hidden')">
                <span id="user-greeting" style="font-size:0.7rem;color:var(--text-secondary);white-space:nowrap;"></span>

                <div id="avatar-dropdown" class="avatar-dropdown hidden">
                    <button class="dropdown-item" id="open-prefs" onclick="location.href='app.html'">
                        <i class="fa-solid fa-sliders"></i> Preferences
                    </button>
                    <a href="updates.html" class="dropdown-item" style="text-decoration:none;color:inherit;">
                        <i class="fa-solid fa-bullhorn"></i> Release Notes
                    </a>
                    <button class="dropdown-item theme-btn">
                        <i class="fa-solid fa-moon"></i> Theme
                    </button>
                    <div style="height: 1px; background: var(--panel-border); margin: 0.3rem 0;"></div>
                    <button class="dropdown-item" id="logout-btn"
                        onclick="supabaseClient.auth.signOut().then(()=>location.href='index.html')">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="result-page">
        <div class="result-header">
            <a href="results.html" class="result-back"><i class="fa-solid fa-arrow-left"></i> All Results</a>
            <span class="result-title"><i class="fa-solid fa-comments" style="color:#10b981;"></i> Mock Interview</span>
            <div style="display: flex; gap: 0.5rem;">
                <button id="refine-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-wand-magic-sparkles"></i> Refine</button>
                <button id="regen-btn" class="btn small-btn ghost-btn"><i class="fa-solid fa-rotate"></i>
                    Regenerate</button>
            </div>
        </div>

        <div
            style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success-color); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; text-align: center;">
            <h3 style="margin-top:0; margin-bottom: 0.4rem; color:var(--text-primary); font-size: 1rem;"><i
                    class="fa-solid fa-microphone"></i> Mock Interview Mode</h3>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">Listen to each question, practice
                your answer out loud, then reveal the ideal framework.</p>
        </div>

        <!-- Progress dots -->
        <div class="mock-progress" id="progress-dots"></div>

        <!-- Single question display -->
        <div id="mock-content">
            <p style="color:var(--text-secondary);text-align:center;padding:3rem 0;">Loading questions...</p>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="gen-overlay"
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
        <div
            style="background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:24px;padding:2.5rem 2rem;text-align:center;display:flex;flex-direction:column;align-items:center;gap:1.25rem;max-width:320px;">
            <div class="resume-anim-wrap" style="transform:scale(0.8);transform-origin:center;">
                <div class="resume-doc">
                    <div class="rdoc-header">
                        <div class="rdoc-avatar"></div>
                        <div class="rdoc-title-lines">
                            <div class="rdoc-line rdoc-line-name"></div>
                            <div class="rdoc-line rdoc-line-sub"></div>
                        </div>
                    </div>
                    <div class="rdoc-section-label"></div>
                    <div class="rdoc-line rdoc-body-line" style="--d:0.1s;--w:92%"></div>
                    <div class="rdoc-line rdoc-body-line" style="--d:0.3s;--w:80%"></div>
                    <div class="rdoc-line rdoc-body-line" style="--d:0.5s;--w:68%"></div>
                    <span class="rdoc-cursor"></span>
                </div>
                <div class="sparkle sp1">âœ¦</div>
                <div class="sparkle sp2">âœ¦</div>
            </div>
            <div>
                <h3 style="margin:0 0 0.4rem;">Generating Questions</h3>
                <p style="color:var(--text-secondary);font-size:0.88rem;margin:0;">Our AI is crafting tailored
                    interview questions for this role...</p>
            </div>
        </div>
    </div>

    <!-- Refinement Modal -->
    <div id="refine-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:20px;padding:2rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
                <h3 style="margin:0;"><i class="fa-solid fa-wand-magic-sparkles" style="color:var(--primary-color);margin-right:0.5rem;"></i>Refine Interview Questions</h3>
                <button onclick="document.getElementById('refine-modal').style.display='none';" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary);">&times;</button>
            </div>
            <p style="color:var(--text-secondary);margin-bottom:1rem;">What would you like to change? Provide specific instructions:</p>
            <textarea id="refine-input" placeholder="e.g., Focus more on technical skills, Add behavioral questions, Make them harder, Focus on leadership..." style="width:100%;height:120px;padding:0.75rem;border:1px solid var(--panel-border);border-radius:8px;background:rgba(255,255,255,0.05);color:var(--text-primary);font-family:inherit;font-size:0.9rem;resize:vertical;"></textarea>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;">
                <button onclick="document.getElementById('refine-modal').style.display='none';" class="btn ghost-btn" style="flex:1;">Cancel</button>
                <button onclick="applyRefinement()" class="btn primary-btn" style="flex:1;"><i class="fa-solid fa-wand-magic-sparkles"></i> Refine</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0"></script>
    <script src="auth.js?v=5"></script>
    <script src="results.js?v=5"></script>
    <script>
        initResultTheme();
        initResultAuth();

        let outputs = loadOutputs();
        let currentQ = 0;
        let questions = [];
        let visitedQs = new Set();
        let mediaRecorder;
        let audioChunks = [];

        const mockContent = document.getElementById('mock-content');
        const progressDots = document.getElementById('progress-dots');
        const overlay = document.getElementById('gen-overlay');

        // â”€â”€ Initialization â”€â”€
        if (!outputs) {
            showSessionExpired(document.querySelector('.result-page'));
        } else if (!outputs.interviewQa || outputs.interviewQa.length === 0) {
            mockContent.innerHTML = `<div style="text-align:center;padding:3rem;"><p style="color:var(--text-secondary);margin-bottom:1.5rem;">Your interview questions haven't been generated yet.</p><button class="btn primary-btn" onclick="generateOnDemand()"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate Questions</button></div>`;
        } else {
            questions = outputs.interviewQa;
            renderMockMode();
        }

        // â”€â”€ On-demand generation â”€â”€
        async function generateOnDemand() {
            overlay.style.display = 'flex';
            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: {
                            parts: [{
                                text: `Generate exactly 10 role-specific interview questions with ideal answer frameworks based on the resume and job description provided. Output ONLY a valid JSON array: [{"question":"...","answer":"..."}]. No markdown, no backticks.`
                            }]
                        },
                        contents: [{
                            parts: [{
                                text: `Resume:\n${outputs.resumeText}\n\nJob Description:\n${outputs.jobText}`
                            }]
                        }],
                        generationConfig: { temperature: 0.7 }
                    }
                });
                if (error) throw new Error(error.message);
                let raw = data.candidates[0].content.parts[0].text.trim().replace(/```json|```/g, '').trim();
                questions = JSON.parse(raw);

                // Cache to sessionStorage
                outputs.interviewQa = questions;
                sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));

                renderMockMode();
            } catch (e) {
                mockContent.innerHTML = `<p style="color:var(--error-color);text-align:center;padding:2rem;">Failed to generate questions: ${e.message}<br><button class="btn small-btn primary-btn" style="margin-top:1rem;" onclick="generateOnDemand()"><i class="fa-solid fa-rotate-right"></i> Retry</button></p>`;
            } finally {
                overlay.style.display = 'none';
            }
        }

        // â”€â”€ Render mock interview (single question at a time) â”€â”€
        function renderMockMode() {
            if (!questions.length) {
                mockContent.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:3rem 0;">No questions generated.</p>';
                return;
            }
            renderProgressDots();
            renderCurrentQuestion();
        }

        function renderProgressDots() {
            progressDots.innerHTML = questions.map((_, i) => {
                let cls = 'progress-dot';
                if (i === currentQ) cls += ' active';
                else if (visitedQs.has(i)) cls += ' done';
                return `<div class="${cls}" title="Question ${i + 1}" style="cursor:pointer;" onclick="goToQuestion(${i})"></div>`;
            }).join('');
        }

        function renderCurrentQuestion() {
            visitedQs.add(currentQ);
            const qa = questions[currentQ];
            const safeQ = qa.question.replace(/`/g, '\\`').replace(/'/g, "\\'");

            mockContent.innerHTML = `
                <div class="mock-question-card">
                    <div class="q-number">Question ${currentQ + 1} of ${questions.length}</div>
                    <div class="q-text-display">"${qa.question}"</div>
                    <div class="q-actions">
                        <button id="tts-btn" class="btn ghost-btn" onclick="hearQuestion()">
                            <i class="fa-solid fa-volume-high"></i> Hear Question
                        </button>
                        <button class="btn ghost-btn" onclick="toggleAnswer()">
                            <i class="fa-solid fa-eye"></i> Show Answer
                        </button>
                    </div>
                </div>

                <div class="answer-reveal" id="answer-reveal">
                    <h4><i class="fa-solid fa-lightbulb"></i> Ideal Answer Framework</h4>
                    <p>${qa.answer}</p>
                </div>

                <div class="practice-section">
                    <h4><i class="fa-solid fa-headset"></i> Practice Your Answer</h4>
                    <div id="recorder-controls">
                        <button class="btn secondary-btn" onclick="startRecording()">
                            <i class="fa-solid fa-microphone"></i> Start Recording
                        </button>
                    </div>
                    <div id="ai-feedback" style="display:none; margin-top: 1.5rem; text-align: left; background: var(--panel-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--panel-border);"></div>
                </div>

                <div class="mock-nav">
                    <button class="btn ghost-btn" onclick="prevQuestion()" ${currentQ === 0 ? 'disabled style="opacity:0.3;pointer-events:none;"' : ''}>
                        <i class="fa-solid fa-arrow-left"></i> Previous
                    </button>
                    <span style="color:var(--text-secondary);font-size:0.85rem;">${currentQ + 1} / ${questions.length}</span>
                    <button class="btn ${currentQ === questions.length - 1 ? 'ghost-btn' : 'primary-btn'}" onclick="nextQuestion()" ${currentQ === questions.length - 1 ? 'disabled style="opacity:0.3;pointer-events:none;"' : ''}>
                        Next <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            `;
            renderProgressDots();
        }

        // â”€â”€ Navigation â”€â”€
        function goToQuestion(idx) {
            stopTTS();
            currentQ = idx;
            renderCurrentQuestion();
        }

        function nextQuestion() {
            if (currentQ < questions.length - 1) {
                stopTTS();
                currentQ++;
                renderCurrentQuestion();
            }
        }

        function prevQuestion() {
            if (currentQ > 0) {
                stopTTS();
                currentQ--;
                renderCurrentQuestion();
            }
        }

        // â”€â”€ Text-to-Speech (ElevenLabs) â”€â”€
        const ttsCache = {}; // Cache audio URLs per question index
        let currentAudio = null;

        async function hearQuestion() {
            const btn = document.getElementById('tts-btn');

            // If audio is playing, stop it
            if (currentAudio && !currentAudio.paused) {
                stopTTS();
                return;
            }
            // If browser TTS is speaking, stop it
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                stopTTS();
                return;
            }

            // Check cache first (ElevenLabs audio)
            if (ttsCache[currentQ]) {
                playAudio(ttsCache[currentQ], btn);
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';

            try {
                // Direct fetch to bypass Supabase client binary handling issues
                const SUPABASE_URL = 'https://gwmpdgjvcjzndbloctla.supabase.co';
                const SUPABASE_KEY = 'sb_publishable_Kor1B60TEAKofYE75aW7Ow_WL0cPOa8';
                const { data: { session } } = await supabaseClient.auth.getSession();
                const token = session?.access_token || SUPABASE_KEY;

                const resp = await fetch(`${SUPABASE_URL}/functions/v1/elevenlabs-tts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'apikey': SUPABASE_KEY
                    },
                    body: JSON.stringify({ text: questions[currentQ].question })
                });

                if (!resp.ok) {
                    const errBody = await resp.json().catch(() => ({}));
                    throw new Error(errBody.error || `TTS request failed (${resp.status})`);
                }

                const audioBlob = await resp.blob();
                const audioUrl = URL.createObjectURL(new Blob([audioBlob], { type: 'audio/mpeg' }));
                ttsCache[currentQ] = audioUrl;

                playAudio(audioUrl, btn);
            } catch (e) {
                console.error('TTS error (falling back to browser):', e);
                playBrowserTTS(questions[currentQ].question, btn);
            }
        }

        function playAudio(url, btn) {
            currentAudio = new Audio(url);
            btn.disabled = false;
            btn.classList.add('speaking');
            btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Stop';

            currentAudio.onended = () => {
                btn.classList.remove('speaking');
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Hear Question';
                currentAudio = null;
            };

            currentAudio.onerror = (e) => {
                console.error('Audio playback error:', currentAudio.error);
                btn.classList.remove('speaking');
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Hear Question';
                currentAudio = null;
                // Fallback to browser TTS
                playBrowserTTS(questions[currentQ].question, btn);
            };

            currentAudio.play().catch(err => {
                console.error('Audio play() failed:', err);
                playBrowserTTS(questions[currentQ].question, btn);
            });
        }

        function playBrowserTTS(text, btn) {
            if (!window.speechSynthesis) {
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> TTS unavailable';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Hear Question';
                }, 3000);
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.95;
            utterance.pitch = 1;

            btn.disabled = false;
            btn.classList.add('speaking');
            btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Stop';

            utterance.onend = () => {
                btn.classList.remove('speaking');
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Hear Question';
            };

            window.speechSynthesis.speak(utterance);
        }

        function stopTTS() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            const btn = document.getElementById('tts-btn');
            if (btn) {
                btn.classList.remove('speaking');
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Hear Question';
            }
        }

        // â”€â”€ Show/Hide Answer â”€â”€
        function toggleAnswer() {
            const el = document.getElementById('answer-reveal');
            el.classList.toggle('visible');
        }

        // â”€â”€ Audio Recording â”€â”€
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    processAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                const controls = document.getElementById('recorder-controls');
                controls.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:center; gap: 1rem;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444; animation: pulseRed 1.5s infinite;"></div>
                        <span style="color:var(--text-primary); font-weight: 500;">Recording...</span>
                        <button class="btn primary-btn" onclick="stopRecording()" style="background: #ef4444; color: white;">
                            <i class="fa-solid fa-stop"></i> Stop & Evaluate
                        </button>
                    </div>
                `;
            } catch (err) {
                console.error("Microphone access error:", err);
                alert("Could not access microphone. Please ensure permissions are granted.");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                const controls = document.getElementById('recorder-controls');
                controls.innerHTML = '<div style="color:var(--text-secondary);"><i class="fa-solid fa-spinner fa-spin"></i> Analyzing your response...</div>';
            }
        }

        async function processAudio(audioBlob) {
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                await submitAudioResponse(base64Audio, audioBlob.type);
            };
        }

        async function submitAudioResponse(base64Audio, mimeType) {
            const feedbackDiv = document.getElementById('ai-feedback');
            const controls = document.getElementById('recorder-controls');
            const questionText = questions[currentQ].question;

            const sysPrompt = `You are an expert executive interview coach.
The user is providing an audio recording of their answer to an interview question.
Listen to the audio, transcribe their core points, and provide immediate, constructive feedback.
Format your response exactly like this:

**Transcription Summary:**
(Briefly summarize what you heard them say)

**Strengths:**
- (Point 1)
- (Point 2)

**Areas for Improvement:**
- (Constructive point 1)
- (Constructive point 2)

**Overall Delivery:**
(Comment on tone, pacing, filler words, and confidence)`;

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: sysPrompt }] },
                        contents: [{
                            parts: [
                                { text: `Question: ${questionText}` },
                                { inlineData: { mimeType: mimeType, data: base64Audio } }
                            ]
                        }],
                        generationConfig: { temperature: 0.4 }
                    }
                });

                if (error) throw new Error(error.message);

                let reviewText = data.candidates[0].content.parts[0].text.trim();
                reviewText = reviewText.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--accent-color); display:block; margin-top:1rem; margin-bottom:0.5rem;">$1</strong>');
                reviewText = reviewText.replace(/- (.*)/g, '<li style="margin-left: 1.5rem; margin-bottom: 0.25rem;">$1</li>');

                feedbackDiv.innerHTML = `<h4 style="margin-top:0; border-bottom: 1px solid var(--panel-border); padding-bottom: 0.5rem;">AI Coach Feedback</h4>${reviewText}`;
                feedbackDiv.style.display = 'block';

                controls.innerHTML = `
                    <button class="btn secondary-btn" onclick="startRecording()">
                        <i class="fa-solid fa-rotate-right"></i> Try Again
                    </button>
                `;
            } catch (e) {
                console.error("Audio Analysis Error:", e);
                feedbackDiv.innerHTML = `<p class="error-text">Failed to analyze audio: ${e.message}</p>`;
                feedbackDiv.style.display = 'block';
                controls.innerHTML = `
                    <button class="btn secondary-btn" onclick="startRecording()">
                        <i class="fa-solid fa-rotate-right"></i> Retry Recording
                    </button>
                `;
            }
        }

        // â”€â”€ Refinement Modal â”€â”€
        document.getElementById('refine-btn').addEventListener('click', () => {
            document.getElementById('refine-modal').style.display = 'flex';
            document.getElementById('refine-input').focus();
        });

        async function applyRefinement() {
            const refinement = document.getElementById('refine-input').value.trim();
            if (!refinement) {
                alert('Please provide refinement instructions.');
                return;
            }

            document.getElementById('refine-modal').style.display = 'none';
            const overlay = document.getElementById('gen-overlay');
            overlay.style.display = 'flex';

            const systemPrompt = `Generate exactly 10 role-specific interview questions with ideal answer frameworks. Apply this refinement request to the questions:
User refinement: "${refinement}"
Output ONLY a valid JSON array: [{"question":"...","answer":"..."}]. No markdown, no backticks.`;

            try {
                const { data, error } = await supabaseClient.functions.invoke('gemini-proxy', {
                    body: {
                        model: 'gemini-3-flash-preview',
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        contents: [{
                            parts: [{
                                text: `Resume:\n${outputs.resumeText}\n\nJob Description:\n${outputs.jobText}`
                            }]
                        }],
                        generationConfig: { temperature: 0.7 }
                    }
                });
                if (error) throw new Error(error.message);
                let raw = data.candidates[0].content.parts[0].text.trim().replace(/```json|```/g, '').trim();
                questions = JSON.parse(raw);
                outputs.interviewQa = questions;
                sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
                currentQ = 0;
                visitedQs.clear();
                renderMockMode();
                overlay.style.display = 'none';
            } catch (e) {
                overlay.style.display = 'none';
                mockContent.innerHTML = `<p style="color:var(--error-color);text-align:center;">Failed to refine: ${e.message}<br><button class="btn small-btn primary-btn" style="margin-top:1rem;" onclick="applyRefinement()"><i class="fa-solid fa-rotate-right"></i> Retry</button></p>`;
            }
        }

        // â”€â”€ Regenerate â”€â”€
        document.getElementById('regen-btn').addEventListener('click', async () => {
            const btn = document.getElementById('regen-btn');
            btn.disabled = true;
            currentQ = 0;
            visitedQs.clear();
            // Force regeneration by clearing cached data
            outputs.interviewQa = null;
            sessionStorage.setItem('tms_outputs', JSON.stringify(outputs));
            await generateOnDemand();
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Regenerate';
        });
    </script>
</body>

</html>